<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>ç¬‘ã„ã®æ®¿å ‚ -Road to Grand Prix-</title>
        <style>
            :root {
                --main-gold: #f0ad4e;
                --bg-dark: #121212;
            }

            body {
                background-color: var(--bg-dark);
                color: #e0e0e0;
                font-family: "Meiryo", sans-serif;
                display: flex;
                justify-content: center;
                padding: 20px;
            }

            .game-wrapper {
                width: 600px;
                background: #222;
                border: 4px solid #444;
                border-radius: 10px;
                overflow: hidden;
            }

            /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
            .header {
                background: #333;
                padding: 15px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                border-bottom: 2px solid var(--main-gold);
            }

            .stat-item {
                margin: 5px 0;
                font-size: 0.9em;
            }

            /* ã‚·ãƒ«ã‚¨ãƒƒãƒˆæ¼”å‡º */
            .visual-area {
                height: 180px;
                background: linear-gradient(to bottom, #111, #333);
                display: flex;
                justify-content: center;
                align-items: flex-end;
                gap: 40px;
                padding-bottom: 20px;
                position: relative;
            }

            .silhouette {
                width: 60px;
                height: 140px;
                background-color: #555;
                clip-path: polygon(50% 0%, 80% 10%, 90% 40%, 80% 90%, 20% 90%, 10% 40%, 20% 10%);
                transition: background-color 0.5s;
                position: relative;
            }

            /* ãƒã‚¯ã‚¿ã‚¤ã‚¢ã‚¤ã‚³ãƒ³ã®ä»£ã‚ã‚Š */
            .silhouette::after {
                content: "â–¼";
                position: absolute;
                top: 15%;
                left: 40%;
                font-size: 10px;
                color: rgba(255, 255, 255, 0.3);
            }

            /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
            .menu-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                padding: 15px;
            }

            button {
                padding: 12px;
                cursor: pointer;
                border: none;
                border-radius: 4px;
                font-weight: bold;
                background: #444;
                color: white;
                transition: 0.2s;
            }

            button:hover {
                background: #555;
            }

            button.action-btn {
                background: var(--main-gold);
                color: #000;
            }

            /* ãƒ©ã‚¤ãƒ–å®Ÿæ³ãƒ­ã‚° */
            #log-screen {
                height: 120px;
                background: #000;
                margin: 15px;
                padding: 10px;
                border: 1px inset #444;
                overflow-y: auto;
                font-size: 0.95em;
            }

            .bakusho {
                color: #ff4444;
                font-size: 1.5em;
                font-weight: 900;
            }

            .suberi {
                color: #44aaff;
                font-size: 0.8em;
            }

            /* å„ªå‹è€…ç™ºè¡¨ã®ã‚³ã‚±ã‚‹ã‚„ã¤ */
            .koketa {
                transform: rotate(-90deg) translateY(40px);
                transition: transform 0.2s ease-in;
                background-color: #aa0000 !important;
            }

            /* 1. ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã®çœŸã£ç™½ãªå¹• */
            #ending-curtain {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                display: none; /* æœ€åˆã¯éš ã—ã¦ãŠã */
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            /* 2. ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ã¨ã€Œå®Œã€ã‚’åŒ…ã‚€ã‚¨ãƒªã‚¢ */
            #ending-content {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            /* 3. ã“ã‚Œã¾ã§ã®æ­©ã¿ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ï¼‰ */
            #staff-roll {
                color: #666; /* å°‘ã—è–„ã„ã‚°ãƒ¬ãƒ¼ã§ã‚¨ãƒ¢ã•ã‚’æ¼”å‡º */
                font-size: 18px;
                line-height: 2;
                margin-bottom: 20px;
                opacity: 0; /* æœ€åˆã¯é€æ˜ */
                font-family: "serif";
                transition: opacity 2s ease-in; /* ã˜ã‚ã£ã¨å‡ºã™ç”¨ */
            }

            /* 4. æœ€å¾Œã®ã€Œå®Œã€ */
            #ending-text {
                color: black;
                font-size: 100px;
                font-family: "serif";
                font-weight: bold;
                opacity: 0; /* æœ€åˆã¯é€æ˜ */
                transition: opacity 3s ease-in; /* ã˜ã‚ã£ã¨å‡ºã™ç”¨ */
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <div class="game-wrapper">
            <div class="header">
                <div>
                    <div class="stat-item">ã‚³ãƒ³ãƒ“: <strong id="combi-name-display">æœªè¨­å®š</strong></div>
                    <div class="stat-item">æ‰€æŒé‡‘: <span id="money">0</span>å††</div>
                    <div class="stat-item">ç›¸æ–¹ã®æ©Ÿå«Œ: <span id="mood">50</span>%</div>
                </div>
                <div style="text-align: right">
                    <div class="stat-item">å¤§ä¼šã¾ã§: <span id="days">30</span>æ—¥</div>
                    <div class="stat-item">è¡£è£…ãƒ©ãƒ³ã‚¯: <span id="outfit-rank">F</span></div>
                    <div class="stat-item">çŸ¥ååº¦: <span id="fame">0</span></div>
                </div>
            </div>

            <div class="visual-area">
                <div id="p1" class="silhouette"></div>
                <div id="p2" class="silhouette"></div>
            </div>

            <div id="log-screen">åŠ‡å ´ã®æ¥½å±‹ã¸ã‚ˆã†ã“ãã€‚ã¾ãšã¯ã‚³ãƒ³ãƒ“åã‚’æ±ºã‚ã‚ˆã†ã€‚</div>

            <div class="menu-grid">
                <button class="action-btn" onclick="openNetaMenu()">ã€ãƒã‚¿ã‚’æ›¸ãã€‘</button>
                <button class="action-btn" onclick="performLive()">ã€ãƒ©ã‚¤ãƒ–å‡ºæ¼”ã€‘</button>
                <button onclick="workBaito()">ã€å–¶æ¥­ãƒ»ãƒã‚¤ãƒˆã€‘</button>
                <button onclick="startRadio()">ã€æ·±å¤œãƒ©ã‚¸ã‚ªã€‘</button>
                <button onclick="snsMarketing()">ã€SNSé‹ç”¨ã€‘</button>
                <button onclick="shopMenu()">ã€è¡£è£…ã‚·ãƒ§ãƒƒãƒ—ã€‘</button>
            </div>
        </div>

        <!-- ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ« -->
        <div id="ending-curtain">
            <div id="ending-content">
                <div id="staff-roll"></div>
                <div id="ending-text">å®Œ</div>
            </div>
        </div>

        <script>
            // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
            let state = {
                money: 1000,
                days: 30,
                mood: 80,
                fame: 0,
                outfit: { name: "ãƒ¨ãƒ¬ãƒ¨ãƒ¬Tã‚·ãƒ£ãƒ„", rank: "D", bonus: 0, color: "#777", synergy: 0.8 },
                skill: { boke: 10, tsukkomi: 10, kousei: 10 },
                isShobufuku: false,
                totalNetaCount: 0, // ä½œã£ãŸãƒã‚¿ã®ç·æ•°
                bestScore: 0, // ã“ã‚Œã¾ã§ã®ãƒ©ã‚¤ãƒ–ã§ã®æœ€é«˜å¾—ç‚¹
            };

            const trendList = ["ã‚·ãƒ¥ãƒ¼ãƒ«", "ã‚ã‚‹ã‚ã‚‹", "ãƒªã‚ºãƒ ", "æ¯’èˆŒ", "ãƒ™ã‚¿"];
            let currentTrend = "ã‚·ãƒ¥ãƒ¼ãƒ«";
            let currentM1Stage = 0;
            let cName = prompt("ã‚³ãƒ³ãƒ“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "æ¯’èˆŒãƒã‚·ãƒ¥ãƒãƒ­");
            document.getElementById("combi-name-display").innerText = cName;

            const M1_STAGES = [
                { name: "1å›æˆ¦", quota: 50, fameGain: 100, msg: "ç·Šå¼µã®åˆæˆ¦ã€‚ã¾ãšã¯è‡ªåˆ†ãŸã¡ã®å½¢ã‚’è¦‹ã›ã‚ï¼" },
                { name: "2å›æˆ¦", quota: 80, fameGain: 300, msg: "å°‘ã—ãšã¤ãƒ—ãƒ­ã®å£ãŒè¦‹ãˆã¦ããŸã€‚å®‰å®šæ„ŸãŒé‡è¦ã€‚" },
                { name: "3å›æˆ¦", quota: 120, fameGain: 800, msg: "ã“ã“ã‹ã‚‰ãŒæœ¬å½“ã®å‹è² ã€‚æ§‹æˆåŠ›ãŒå•ã‚ã‚Œã‚‹ã€‚" },
                { name: "æº–ã€…æ±ºå‹", quota: 180, fameGain: 2000, msg: "ä¼šå ´ã®ç†±æ°—ã‚‚æœ€é«˜æ½®ï¼å…¨å›½ã®ãƒ©ã‚¤ãƒãƒ«ãŒé›†çµã€‚" },
                { name: "æº–æ±ºå‹", quota: 250, fameGain: 5000, msg: "ãƒ•ã‚¡ã‚¤ãƒŠãƒªã‚¹ãƒˆã¾ã§ã‚ã¨ä¸€æ­©ã€‚ä¼èª¬ã‚’ä½œã‚Œã€‚" },
                { name: "æ±ºå‹", quota: 350, fameGain: 20000, msg: "ã›ã‚Šä¸ŠãŒã‚Šã‹ã‚‰ç™»å ´ã€‚ã‚µãƒ³ãƒ‘ãƒãƒã‚¤ã‚¯ãŒå¾…ã£ã¦ã„ã‚‹ã€‚" },
            ];

            // --- å…±é€šå‡¦ç† ---
            function updateUI() {
                document.getElementById("money").innerText = state.money;
                document.getElementById("days").innerText = state.days;
                document.getElementById("mood").innerText = state.mood;
                document.getElementById("fame").innerText = state.fame;
                document.getElementById("outfit-rank").innerText = state.outfit.rank;
                document.getElementById("p1").style.backgroundColor = state.outfit.color;
                document.getElementById("p2").style.backgroundColor = state.outfit.color;
            }

            function addLog(html) {
                const log = document.getElementById("log-screen");
                log.innerHTML = `<div style="margin-bottom:8px;">${html}</div>` + log.innerHTML;
            }

            // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
            function workBaito() {
                if (state.days <= 0) {
                    startM1Tournament();
                    return;
                }
                let earned = 5000 + state.fame * 0.1;
                state.money += Math.floor(earned);
                state.days--;
                state.mood -= 10;
                addLog(`ã€ãƒã‚¤ãƒˆã€‘æ±—æ°´æµã—ã¦ ${Math.floor(earned)}å†† ç¨¼ã„ã ã€‚ç›¸æ–¹ã®æ©Ÿå«ŒãŒä¸‹ãŒã£ãŸã€‚`);
                checkDissolution();
                updateUI();
            }

            // è¡£è£…ãƒ»å‡ºå›ƒå­ã‚·ãƒ§ãƒƒãƒ—
            function shopMenu() {
                let msg = "ä½•ã‚’è²·ã†ï¼Ÿï¼ˆç¾åœ¨ã®æ‰€æŒé‡‘: " + state.money + "å††ï¼‰\n";
                msg += "1:æ­£çµ±æ´¾ãƒã‚¤ãƒ“ãƒ¼(5000å††/ãƒ©ãƒ³ã‚¯C)\n";
                msg += "2:çœŸã£èµ¤ãªãƒ€ãƒ–ãƒ«(15000å††/ãƒ©ãƒ³ã‚¯B)\n";
                msg += "3:ãƒ©ãƒ¡å…¥ã‚Šã‚¹ãƒ‘ãƒ³ã‚³ãƒ¼ãƒ«(50000å††/ãƒ©ãƒ³ã‚¯A)\n";
                msg += "4:ç‰¹æ³¨ã®å‡ºå›ƒå­(30000å††/ãƒ©ã‚¤ãƒ–åŠ ç‚¹)";

                let choice = prompt(msg);
                if (choice == "1" && state.money >= 5000) {
                    state.outfit = { name: "æ­£çµ±æ´¾ãƒã‚¤ãƒ“ãƒ¼", rank: "C", bonus: 20, color: "#000080", synergy: 1.2 };
                    state.money -= 5000;
                    addLog("ã€è¡£è£…ã€‘æ­£çµ±æ´¾ãƒã‚¤ãƒ“ãƒ¼ã‚’è³¼å…¥ã€‚å¯©æŸ»å“¡ã‚¦ã‚±ãŒè‰¯ããªã£ãŸã€‚");
                } else if (choice == "2" && state.money >= 15000) {
                    state.outfit = { name: "çœŸã£èµ¤ãªãƒ€ãƒ–ãƒ«", rank: "B", bonus: 40, color: "#cc0000", synergy: 1.0 };
                    state.money -= 15000;
                    addLog("ã€è¡£è£…ã€‘èµ¤ã„ãƒ€ãƒ–ãƒ«ã‚’è³¼å…¥ã€‚ãƒ†ãƒ¬ãƒ“æ˜ ãˆã—ãã†ã ã€‚");
                } else if (choice == "3" && state.money >= 50000) {
                    state.outfit = { name: "ãƒ©ãƒ¡å…¥ã‚Šã‚¹ãƒ‘ãƒ³ã‚³ãƒ¼ãƒ«", rank: "A", bonus: 80, color: "#ffd700", synergy: 1.5 };
                    state.money -= 50000;
                    addLog("ã€è¡£è£…ã€‘ãƒ©ãƒ¡ã‚¹ãƒ¼ãƒ„ã‚’è³¼å…¥ï¼ç‹è€…ã®é¢¨æ ¼ãŒå‡ºã¦ããŸã€‚");
                } else if (choice == "4" && state.money >= 30000) {
                    state.hasDebayashi = true;
                    state.money -= 30000;
                    addLog("ã€å‡ºå›ƒå­ã€‘è‡ªåˆ†ãŸã¡å°‚ç”¨ã®æ›²ã‚’è³¼å…¥ï¼ãƒ©ã‚¤ãƒ–ã®ã¤ã‹ã¿ãŒå®‰å®šã™ã‚‹ã€‚");
                } else {
                    addLog("è³¼å…¥ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã‹ã€ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
                }
                updateUI();
            }

            function performLive() {
                if (state.days <= 0) {
                    startM1Tournament();
                    return;
                }

                if (state.outfit.rank === "D" && Math.random() > 0.5) {
                    addLog("<span class='suberi'>ã€åœ°ä¸‹ãƒ©ã‚¤ãƒ–ã€‘è¡£è£…ãŒæ±šã™ãã¦å‡ºç¦ã«ãªã‚Šã‹ã‘ãŸã€‚</span>");
                }

                let score = (state.skill.boke + state.skill.tsukkomi) * (state.mood / 100) * state.outfit.synergy + state.outfit.bonus;
                let total = score + Math.random() * 50;

                state.days--;
                state.fame += Math.floor(total / 10);

                if (total > 80) {
                    addLog(`<span class='bakusho'>ãƒ‰ã‚«ãƒ³ï¼ï¼ å¤§çˆ†ç¬‘ï¼</span> (${Math.floor(total)}ç‚¹)`);
                    state.mood = Math.min(100, state.mood + 10);
                } else {
                    addLog(`<span class='suberi'>â€¦â€¦ã‚·ãƒ¼ãƒ³ã€‚ã‚¹ãƒ™ã£ãŸã€‚</span> (${Math.floor(total)}ç‚¹)`);
                    state.mood -= 10;
                }

                // æœ€é«˜å¾—ç‚¹ã‚’æ›´æ–°ã™ã‚‹
                if (total > state.bestScore) {
                    state.bestScore = Math.floor(total);
                }

                checkDissolution();
                updateUI();
            }

            function openNetaMenu() {
                if (state.days <= 0) {
                    startM1Tournament();
                    return;
                }

                let selectedType = prompt(`ã©ã‚“ãªãƒã‚¿ã‚’æ›¸ãï¼Ÿ\n1:ã‚·ãƒ¥ãƒ¼ãƒ« 2:ã‚ã‚‹ã‚ã‚‹ 3:ãƒªã‚ºãƒ  4:æ¯’èˆŒ 5:ãƒ™ã‚¿`);
                let typeName = trendList[parseInt(selectedType) - 1] || "ãƒ™ã‚¿";

                let bonusMult = typeName === currentTrend ? 2 : 1;
                if (bonusMult === 2) addLog("<strong>ãƒˆãƒ¬ãƒ³ãƒ‰ä¸€è‡´ï¼ç¥ãƒã‚¿ã®äºˆæ„Ÿï¼</strong>");

                state.skill.boke += 5 * bonusMult;
                state.skill.tsukkomi += 5 * bonusMult;
                state.days--;
                state.totalNetaCount++;

                addLog(`ã€ãƒã‚¿ä½œã‚Šã€‘${typeName}ãƒã‚¿ã‚’å¼·åŒ–ã€‚è…•ãŒä¸ŠãŒã£ãŸã€‚`);
                updateTrend();
                updateUI();
            }

            // çŠ¶æ…‹å¤‰æ•°ã«ã€Œãƒ©ã‚¸ã‚ªçµŒé¨“ã€ã‚’éš ã—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ ã—ã¦ãŠãã¨ä¾¿åˆ©
            state.radioPower = 0;

            function startRadio() {
                if (state.days <= 0) return;
                state.days--;

                state.mood = Math.min(100, state.mood + 15); // ç›¸æ–¹ã®æ©Ÿå«ŒãŒå›å¾©
                state.radioPower += 5; // ãƒ©ã‚¤ãƒ–æ™‚ã®æœ€ä½é‹å€¤ã‚’åº•ä¸Šã’ã™ã‚‹ç”¨

                addLog("ã€ãƒ©ã‚¸ã‚ªã€‘æ·±å¤œã®ç”Ÿæ”¾é€ã€‚ã‚³ã‚¢ãªãƒ•ã‚¡ãƒ³å±¤ãŒå½¢æˆã•ã‚Œã€ç›¸æ–¹ã¨ã®çµ†ã‚‚æ·±ã¾ã£ãŸã€‚");
                updateUI();
            }

            // ãƒãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹
            function snsMarketing() {
                if (state.days <= 0) return;
                state.days--;
                let luck = Math.random();

                if (luck > 0.8) {
                    // ãƒã‚ºã£ãŸæ™‚
                    const newsTitles = [
                        `ã€Œ${cName}ã€æ¬¡ä¸–ä»£ã®ã‚¹ã‚¿ãƒ¼å€™è£œã‹ï¼Ÿã€`,
                        `ã€Œã€é€Ÿå ±ã€‘${cName}ã®ãƒã‚¿ãŒä¸­æ¯’æ€§é«˜ã™ãã‚‹ã¨è©±é¡Œã€`,
                        `ã€Œ${cName}ã€SNSã§ã¾ã•ã‹ã®å¤§ãƒã‚ºã‚Šã€‚ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ€¥å¢—ä¸­ã€`,
                    ];
                    let title = newsTitles[Math.floor(Math.random() * newsTitles.length)];
                    state.fame += 1000;
                    addLog(`<span style="color:orange;">ã€ãƒãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘${title}</span>`);
                } else {
                    state.fame += 100;
                    addLog("ã€SNSã€‘åœ°é“ãªæ›´æ–°ã€‚å°‘ã—ãšã¤ãƒ•ã‚¡ãƒ³ãŒå¢—ãˆã¦ã„ã‚‹ã€‚");
                }
                updateUI();
            }

            // --- å¤§ä¼šãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ ---
            function startM1Tournament() {
                let stage = M1_STAGES[currentM1Stage];

                // --- ã‚µãƒ³ãƒ‘ãƒãƒã‚¤ã‚¯æ¼”å‡º ---
                addLog(
                    "<div style='color:white; background:#555; text-align:center; padding:5px;'> ï½œ <br> ï½œ <br> ã€Œâ€¦ã©ã†ã‚‚ãƒ¼ï¼ã€ </div>"
                );
                addLog(`<div style="border: 2px double gold; padding: 10px; background:#444;">ã€M-1 ${stage.name}ã€‘ ${stage.msg}</div>`);

                let score = (state.skill.boke + state.skill.tsukkomi) * (state.mood / 100) * state.outfit.synergy + state.outfit.bonus;

                // å¯©æŸ»å“¡ã®ç›¸æ€§ãƒã‚§ãƒƒã‚¯ (æ±ºå‹ã®ã¿)
                if (stage.name === "æ±ºå‹") {
                    let judgeBonus = 0;
                    const judges = [
                        { name: "å¤§å¾¡æ‰€å¸«åŒ ", preference: "æ­£çµ±æ´¾ãƒã‚¤ãƒ“ãƒ¼" },
                        { name: "ä¸­å …ã‚³ãƒ³ãƒˆå¸«", preference: "ã‚·ãƒ¥ãƒ¼ãƒ«" },
                        { name: "ãƒ†ãƒ¬ãƒ“å±€P", preference: "ãƒ©ãƒ¡å…¥ã‚Šã‚¹ãƒ‘ãƒ³ã‚³ãƒ¼ãƒ«" },
                    ];
                    judges.forEach((j) => {
                        if (state.outfit.name === j.preference || currentTrend === j.preference) {
                            judgeBonus += 20;
                            addLog(`<small>${j.name}ï¼šå¥½ã¿ã®ã‚¿ã‚¤ãƒ—ã ã­â€¦</small>`);
                        }
                    });
                    score += judgeBonus;
                }

                if (state.hasDebayashi) score += 15;
                let finalScore = Math.floor(score + Math.random() * 40);

                // --- é™å¯‚ã¨CMã®æ¼”å‡º ---
                addLog("å¾—ç‚¹ã€å‡ºã¾ã—ãŸã€‚");

                setTimeout(() => {
                    addLog("â€¦â€¦â€¦â€¦â€¦â€¦");
                }, 1000);
                setTimeout(() => {
                    addLog("â€¦â€¦â€¦â€¦â€¦â€¦");
                }, 2000);

                // æ±ºå‹ã®å ´åˆã®ã¿ã€ç™ºè¡¨å‰ã«ã‚¿ãƒ¡ã‚’ä½œã‚‹
                if (stage.name === "æ±ºå‹") {
                    // 1. CMå‰ã®ã‚¿ãƒ¡ï¼ˆ3ç§’ï¼‰
                    setTimeout(() => {
                        addLog("<strong style='color:#00ffff;'>ã€Œå„ªå‹è€…ã¯â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦ä»Šå¹´ã‚‚â€¦ï¼â€¦â€¦â€¦CMã®ã‚ã¨ã§ã™ï¼ã€</strong>");
                    }, 3000);

                    // 2. ã‚ºãƒƒã‚³ã‚±ï¼ˆ3.2ç§’ï¼‰
                    setTimeout(() => {
                        addLog("<strong>ï¼ˆã‚ºã‚³ãƒ¼ãƒƒï¼ï¼ï¼‰</strong>");
                        document.getElementById("p1").classList.add("koketa");
                        document.getElementById("p2").classList.add("koketa");
                    }, 3200);

                    // 3. CMæ˜ã‘ï¼ˆ5.5ç§’å¾Œï¼‰
                    setTimeout(() => {
                        document.getElementById("p1").classList.remove("koketa");
                        document.getElementById("p2").classList.remove("koketa");
                        addLog("ï¼ˆCMæ˜ã‘ï¼‰");

                        // --- ã“ã“ã‚’ä¿®æ­£ï¼šCMå‰ã¨åŒã˜ãã€Œ3ç§’ã€æºœã‚ã¦ã‹ã‚‰çµæœç™ºè¡¨ ---
                        setTimeout(() => {
                            displayM1Result(finalScore, stage);
                        }, 3000); // ã“ã“ã‚’3000(3ç§’)ã«ã™ã‚‹ã“ã¨ã§ã€CMå‰ã¨åŒã˜ç·Šå¼µæ„Ÿã«ãªã‚Šã¾ã™
                    }, 5500);
                } else {
                    // æ±ºå‹ä»¥å¤–ã¯é€šå¸¸é€šã‚Š
                    setTimeout(() => {
                        displayM1Result(finalScore, stage);
                    }, 3000);
                }
            }

            // åˆ¤å®šå‡¦ç†ã‚’ã¾ã¨ã‚ãŸãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚åˆ†é›¢ï¼‰
            // --- åˆ¤å®šå‡¦ç†ã®ä¿®æ­£ï¼šäºˆé¸æ•—é€€ã§ã‚‚ã‚¨ãƒ³ãƒ‰ã¸ ---
            function displayM1Result(finalScore, stage) {
                addLog(`çµæœï¼š<strong>${finalScore}ç‚¹</strong>ï¼ˆé€šéãƒ©ã‚¤ãƒ³: ${stage.quota}ç‚¹ï¼‰`);

                if (finalScore >= stage.quota) {
                    state.fame += stage.fameGain;

                    if (currentM1Stage < M1_STAGES.length - 1) {
                        addLog(`<span style="color:yellow;">ç¥ãƒ»${stage.name}é€šéï¼</span>`);
                        currentM1Stage++;
                        state.days = 3;
                    } else {
                        // --- å„ªå‹ã®æ¼”å‡ºãƒ•ãƒ­ãƒ¼ ---
                        addLog("<span class='bakusho'>ã€å„ªå‹ã€‘ç¬¬21ä»£ç‹è€…ã¯â€¦ã€Œ" + cName + "ã€ï¼ï¼</span>");

                        // 3ç§’å¾…ã£ã¦ã‹ã‚‰ç´™å¹é›ªã‚’é–‹å§‹ï¼ˆåå‰ã‚’èª­ã¾ã›ã‚‹ï¼‰
                        setTimeout(() => {
                            const count = 15;
                            const interval = 200;
                            for (let i = 0; i < count; i++) {
                                setTimeout(() => {
                                    const colors = ["#FFD700", "#FF69B4", "#00FFFF", "#ADFF2F", "#FFA500"];
                                    const icons = ["ğŸŒ¸", "âœ¨", "ğŸŠ", "âœ¨", "â­", "ğŸ‰"];
                                    const randomColor = colors[Math.floor(Math.random() * colors.length)];
                                    const randomIcon = icons[Math.floor(Math.random() * icons.length)];
                                    const spaces = "&nbsp;".repeat(Math.floor(Math.random() * 20));
                                    addLog(
                                        `<div style="color:${randomColor}; font-size:1.2em;">${spaces}${randomIcon} âœ¨ ${randomIcon}${spaces}</div>`
                                    );
                                }, i * interval);
                            }

                            // å„ªå‹ã‚¨ãƒ³ãƒ‰ã¸
                            // ã€ä¿®æ­£ã€‘ç´™å¹é›ªãŒçµ‚ã‚ã‚‹ã®ãŒ (15 * 200ms = 3ç§’å¾Œ)
                            // ãã“ã‹ã‚‰ 2ç§’å¾…æ©Ÿã—ã¦ç™½è»¢ã•ã›ã‚‹ãŸã‚ã€ç´™å¹é›ªé–‹å§‹ã‹ã‚‰ 5ç§’å¾Œã«å®Ÿè¡Œ
                            setTimeout(() => triggerEnding("victory"), 5000);
                        }, 3000);
                    }
                } else {
                    // æ•—é€€æ™‚ã®ã‚ºãƒƒã‚³ã‚±æ¼”å‡ºï¼ˆã“ã“ã«å…¥ã‚Œã‚‹ã¨ã€Œåå‰ãŒå‡ºãŸç¬é–“ã€ã«ã“ã‘ã¾ã™ï¼‰
                    document.getElementById("p1").classList.add("koketa");
                    document.getElementById("p2").classList.add("koketa");

                    if (stage.name === "æº–æ±ºå‹") {
                        tryHaishaFukkatsu(finalScore); // æº–æ±ºå‹ã ã‘ã¯ã¾ã ãƒãƒ£ãƒ³ã‚¹ã‚ã‚Š
                    } else {
                        // 1å›æˆ¦ã€œæº–ã€…æ±ºå‹ã€ãŠã‚ˆã³æ±ºå‹ã§è² ã‘ãŸå ´åˆ
                        addLog(`<span class='suberi'>${stage.name}æ•—é€€ã€‚</span>`); // 3ç§’å¾…ã£ã¦ã‹ã‚‰ã€Œè² ã‘ã‚¨ãƒ³ãƒ‰ã€ã¸
                        setTimeout(() => triggerEnding("defeat"), 3000);
                    }
                }
                updateUI();
            }

            function tryHaishaFukkatsu(score) {
                addLog("ã€æ•—è€…å¾©æ´»æˆ¦ã€‘è¦–è´è€…æŠ•ç¥¨ã®çµæœã¯â€¦ï¼Ÿ");
                setTimeout(() => {
                    if (score + Math.random() * 50 > 280) {
                        addLog("<span style='color:orange;'>å¥‡è·¡ã®æ•—è€…å¾©æ´»ï¼æ±ºå‹ã¸ï¼</span>");
                        currentM1Stage = 5;
                        state.days = 1;
                    } else {
                        addLog("æƒœã—ãã‚‚æ•—é€€ã€‚");
                        // â˜…ä¿®æ­£: ãã®ã¾ã¾ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã¸
                        setTimeout(() => triggerEnding("defeat"), 3000);
                    }
                }, 2000);
            }

            function checkDissolution() {
                if (state.mood < 20) {
                    if (confirm("ç›¸æ–¹ã€Œè§£æ•£ã ï¼ã€åœŸä¸‹åº§ã—ã¦å¼•ãæ­¢ã‚ã¾ã™ã‹ï¼Ÿï¼ˆæ‰€æŒé‡‘åŠåˆ†ï¼‰")) {
                        state.money = Math.floor(state.money / 2);
                        state.mood = 50;
                        addLog("ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘å¿…æ­»ã«å¼•ãæ­¢ã‚ãŸã€‚");
                    } else {
                        alert("ã‚³ãƒ³ãƒ“è§£æ•£ã€‚");
                        location.reload();
                    }
                }
            }

            function updateTrend() {
                if (state.days % 5 === 0) {
                    currentTrend = trendList[Math.floor(Math.random() * trendList.length)];
                    addLog(`<span style="color:#00ff00;">ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã€‘</span> ä¸–é–“ã¯<strong>ã€Œ${currentTrend}ã€</strong>ã‚’æ±‚ã‚ã¦ã„ã‚‹ï¼`);
                }
            }

            function triggerEnding(type) {
                // ä½™éŸ»ã¯ displayM1Result å´ã§åˆ¶å¾¡ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã¯å³åº§ã«å®Ÿè¡Œ
                const curtain = document.getElementById("ending-curtain");
                const staffRoll = document.getElementById("staff-roll");
                const text = document.getElementById("ending-text");

                // ç™½ã„å¹•ã‚’è¡¨ç¤º
                curtain.style.display = "flex";

                // â˜…ä¿®æ­£: æ•—é€€ï¼ˆdefeatï¼‰ãªã‚‰èƒŒæ™¯ã‚’æš—ãã€å„ªå‹ãªã‚‰ç™½ãã™ã‚‹
                if (type === "defeat") {
                    curtain.style.background = "#222";
                    staffRoll.style.color = "#aaa";
                } else {
                    curtain.style.background = "white";
                    staffRoll.style.color = "#666";
                }

                // â˜…ä¿®æ­£: è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†å²
                let mainMsg = type === "victory" ? "ä»Šæ—¥ã€äººç”ŸãŒå¤‰ã‚ã£ãŸã€‚" : "ã€Œâ€¦å¤‰ã‚ã‚“ã­ãˆãªã€äººç”Ÿã€‚ã€";
                let subMsg =
                    type === "victory"
                        ? "ã¤ã„ã«é ‚ç‚¹ã¸ã€‚é³´ã‚Šæ­¢ã¾ãªã„æ‹æ‰‹ã€‚"
                        : `${M1_STAGES[currentM1Stage].name}æ•—é€€ã€‚äººç”Ÿã‚’å¤‰ãˆã«æ¥ãŸã¯ãšã ã£ãŸã€‚`;

                // 2. ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ã®å†…å®¹ã‚’æµã™
                staffRoll.innerHTML = `
            <h2 style="color:${type === "victory" ? "black" : "#eee"};">${type === "victory" ? "âœ¨ æ—¥æœ¬ä¸€ âœ¨" : "â˜ï¸ æ•—é€€ â˜ï¸"}</h2>
            <p style="font-size: 1.2em; margin: 20px 0; font-weight: bold;">${mainMsg}</p>
            <p style="font-style: italic; margin-bottom: 30px;">${subMsg}</p>
            <p>ã‚³ãƒ³ãƒ“åï¼š${cName}</p>
            <p>æœ€é«˜æˆç¸¾ï¼š${M1_STAGES[currentM1Stage].name}</p>
            <p>ä½œã£ãŸãƒã‚¿ã®æ•°ï¼š${state.totalNetaCount} æœ¬</p>
            <p>æœ€é«˜å¾—ç‚¹ï¼š${state.bestScore} ç‚¹</p>
            <p style="margin-top:40px; font-weight:bold;">åˆ¶ä½œï¼šã‚ãªãŸ</p>
        `;

                // 3. æ¼”å‡ºã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                // 1ç§’å¾Œã«ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤º
                setTimeout(() => {
                    staffRoll.style.opacity = "1";
                    staffRoll.style.transition = "opacity 2s ease-in";
                }, 1000);

                // 4ç§’å¾Œã«ã€Œå®Œã€ã‚’è¡¨ç¤º
                setTimeout(() => {
                    text.style.opacity = "1";
                }, 4000);

                // 8ç§’å¾Œã«å†ã‚¹ã‚¿ãƒ¼ãƒˆç¢ºèª
                setTimeout(() => {
                    // â˜…ä¿®æ­£: çµ‚ã‚ã‚Šã®å•ã„ã‹ã‘ã‚‚ã‚¨ãƒ¢ãå¤‰æ›´
                    let confirmMsg =
                        type === "victory" ? "ä¼èª¬ã¯å¹•ã‚’é–‰ã˜ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã€è‹¥æ‰‹æ™‚ä»£ã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ" : "äººç”Ÿã€å¤‰ãˆã«è¡Œãã¾ã™ã‹ï¼Ÿ";
                    if (confirm(confirmMsg)) {
                        location.reload();
                    }
                }, 8000);
            }

            updateUI();
        </script>
    </body>
</html>
