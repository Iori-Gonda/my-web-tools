<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Study Sparkle Timer Pro</title>
        <style>
            :root {
                /* Pink Theme (Default) */
                --bg: #fdf2f8;
                --primary: #ec4899;
                --secondary: #fbcfe8;
                --text: #831843;
                --accent: #fbbf24;
            }
            /* Blue Theme */
            body.blue-mode {
                --bg: #f0f9ff;
                --primary: #0ea5e9;
                --secondary: #bae6fd;
                --text: #0c4a6e;
                --accent: #22c55e;
            }

            body {
                background-color: var(--bg);
                color: var(--text);
                font-family: "Arial Rounded MT Bold", sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                margin: 0;
                transition: 0.5s;
            }

            .container {
                background: white;
                padding: 2rem;
                border-radius: 40px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.05);
                text-align: center;
                width: 320px;
                border: 4px solid var(--secondary);
                position: relative;
            }

            /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚µãƒ¼ã‚¯ãƒ« */
            .progress-container {
                position: relative;
                width: 200px;
                height: 200px;
                margin: 20px auto;
            }

            svg {
                transform: rotate(-90deg);
            }

            .circle-bg {
                fill: none;
                stroke: var(--secondary);
                stroke-width: 10;
            }

            .circle-progress {
                fill: none;
                stroke: var(--primary);
                stroke-width: 10;
                stroke-linecap: round;
                stroke-dasharray: 565.48; /* 2 * PI * 90 */
                stroke-dashoffset: 565.48;
                transition: stroke-dashoffset 0.1s linear;
            }

            .timer-display {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ 2.2rem ã‹ã‚‰ 1.8rem ç¨‹åº¦ã«ä¸‹ã’ã‚‹ */
                font-size: 1.8rem;
                font-weight: bold;
                color: var(--primary);
                /* æ–‡å­—ãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«æ¨ªå¹…ã‚’å›ºå®šã—ã€æŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã«ã™ã‚‹ */
                width: 100%;
                white-space: nowrap;
                text-align: center;
                /* æ•°å­—ã®å¹…ã‚’ä¸€å®šã«ã™ã‚‹ï¼ˆã‚¬ã‚¿ã¤ãé˜²æ­¢ï¼‰ */
                font-variant-numeric: tabular-nums;
            }

            .goal-setting {
                margin-bottom: 15px;
                font-size: 0.9rem;
            }

            input[type="number"] {
                width: 50px;
                padding: 5px;
                border-radius: 10px;
                border: 2px solid var(--secondary);
                text-align: center;
            }

            .controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            button {
                padding: 12px;
                border: none;
                border-radius: 20px;
                font-weight: bold;
                cursor: pointer;
                transition: 0.2s;
            }

            .btn-start {
                background: var(--primary);
                color: white;
                grid-column: span 2;
            }

            .btn-theme {
                margin-top: 15px;
                background: transparent;
                border: 2px solid var(--secondary);
                color: var(--text);
                font-size: 0.8rem;
            }

            .lap-list {
                margin-top: 1.5rem;
                max-height: 120px;
                overflow-y: auto;
                border-top: 2px dashed var(--secondary);
                padding-top: 10px;
            }

            .lap-item {
                display: flex;
                justify-content: space-between;
                padding: 5px 10px;
                background: #fff5f8;
                margin-bottom: 5px;
                border-radius: 10px;
                font-size: 0.8rem;
            }

            .sparkle {
                position: absolute;
                width: 10px;
                height: 10px;
                background: var(--accent);
                border-radius: 50%;
                pointer-events: none;
                animation: fly 0.8s ease-out forwards;
            }

            @keyframes fly {
                0% {
                    transform: translate(0, 0) scale(1);
                    opacity: 1;
                }
                100% {
                    transform: translate(var(--x), var(--y)) scale(0);
                    opacity: 0;
                }
            }

            /* è¿½åŠ ï¼šã‚¬ãƒ¼ãƒ‡ãƒ³ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            .magic-section {
                margin-top: 20px;
                border-top: 2px dashed var(--secondary);
                padding-top: 15px;
            }

            .garden-display {
                font-size: 1.5rem;
                min-height: 40px;
                background: #fdf2f8;
                border-radius: 15px;
                padding: 10px;
                margin: 10px 0;
            }

            .status-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 5px;
                font-size: 0.8rem;
                text-align: left;
                background: #fff;
                padding: 10px;
                border-radius: 15px;
            }

            .crystal-ball {
                font-size: 3rem;
                cursor: pointer;
                transition: 0.3s;
                filter: drop-shadow(0 0 10px var(--secondary));
            }

            .crystal-ball:hover {
                transform: scale(1.1);
            }

            .poem-display {
                font-style: italic;
                font-size: 0.85rem;
                color: var(--primary);
                margin-top: 10px;
                min-height: 3em;
            }

            /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼æ¼”å‡º */
            .btn-start {
                transition: all 0.3s ease; /* å¤‰åŒ–ã‚’ãµã‚ã£ã¨ã•ã›ã‚‹ */
            }

            .btn-start:hover {
                background-color: #f472b6 !important; /* å°‘ã—æ˜ã‚‹ã„ãƒ”ãƒ³ã‚¯ã« */
                box-shadow: 0 8px 20px rgba(236, 72, 153, 0.4); /* ãµã‚ã£ã¨æµ®ãå‡ºã‚‹å½± */
                transform: translateY(-2px); /* å°‘ã—ä¸Šã«æµ®ãä¸ŠãŒã‚‹ */
            }

            .btn-start:active {
                transform: translateY(1px); /* ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«å°‘ã—æ²ˆã‚€ */
            }

            /* ãƒ–ãƒ«ãƒ¼ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãƒ›ãƒãƒ¼ */
            body.blue-mode .btn-start:hover {
                background-color: #38bdf8 !important; /* å°‘ã—æ˜ã‚‹ã„é’ã« */
                box-shadow: 0 8px 20px rgba(14, 165, 233, 0.4);
            }

            /* å…¨ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼æ¼”å‡º */
            button[onclick="resetAllMagicData()"] {
                transition: all 0.3s ease;
                border: 2px solid transparent;
            }

            button[onclick="resetAllMagicData()"]:hover {
                background-color: #ef4444 !important; /* ã‚ˆã‚Šé®®ã‚„ã‹ãªèµ¤ã« */
                box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); /* èµ¤ãå…‰ã‚‹ */
                transform: translateY(2px); /* æŠ¼ã—ãŸæ„Ÿã˜ã‚’å‡ºã™ */
                letter-spacing: 1px; /* æ–‡å­—ã‚’å°‘ã—åºƒã’ã¦å¼·èª¿ */
            }

            button[onclick="resetAllMagicData()"]:active {
                transform: translateY(4px) scale(0.98); /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æ²ˆã¿è¾¼ã¿ */
            }

            button[onclick="resetAllMagicData()"]:hover::before {
                content: "âš ï¸ ";
            }

            /* çµµæ–‡å­—ãŒé£›ã³å‡ºã™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            .particle {
                position: absolute;
                pointer-events: none;
                font-size: 1.5rem;
                z-index: 100;

                animation: particle-fly 1.2s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;
            }

            @keyframes particle-fly {
                0% {
                    transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
                    opacity: 1; /* å‡ºç¾æ™‚ã¯å®Œå…¨ã«ã‚¯ãƒƒã‚­ãƒª */
                }
                80% {
                    opacity: 0.5; /* ã„ã„æ„Ÿã˜ã®é€æ˜åº¦ã« */
                }
                100% {
                    transform: translate(var(--mx), var(--my)) rotate(var(--rt)) scale(1.8);
                    opacity: 0; /* æœ€å¾Œã ã‘ãƒ•ãƒƒã¨æ¶ˆãˆã‚‹ */
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ’» Study Timer</h1>

            <div class="goal-setting">ç›®æ¨™ï¼š<input type="number" id="goalInput" value="25" min="1" /> åˆ†</div>

            <div class="progress-container">
                <svg width="200" height="200">
                    <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                    <circle id="progressBar" class="circle-progress" cx="100" cy="100" r="90"></circle>
                </svg>
                <div class="timer-display" id="display">00:00.00</div>
            </div>

            <div class="controls">
                <button class="btn-start" id="startBtn" onclick="toggleTimer()">START</button>
                <button style="background: var(--secondary)" onclick="recordLap()">LAP</button>
                <button style="background: #eee" onclick="resetTimer()">RESET</button>
                <button style="background: #fca5a5; color: white; font-size: 0.7rem; grid-column: span 2" onclick="resetAllMagicData()">âœ¨ é­”æ³•ã®åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨åˆæœŸåŒ–ï¼‰</button>
            </div>

            <div class="magic-section">
                <div class="status-grid">
                    <div>âœ¨ é›†ä¸­Lv: <span id="lv-focus">1</span></div>
                    <div>ğŸ“– çŸ¥è­˜EXP: <span id="exp-knowledge">0</span></div>
                    <div style="grid-column: span 2; border-top: 1px solid #eee; margin-top: 5px; padding-top: 5px">ğŸ“… ä»Šæ—¥ã®åˆè¨ˆ: <span id="today-total">00:00:00</span></div>
                </div>

                <div class="garden-display" id="garden">ğŸŒ± (åº­ã‚’è‚²ã¦ã‚ˆã†)</div>

                <div class="crystal-ball" onclick="touchCrystal()">ğŸ”®</div>
                <div id="crystal-msg" style="font-size: 0.8rem; margin-bottom: 10px">æ°´æ™¶ã«è§¦ã‚Œã¦...</div>

                <button class="btn-theme" style="width: 100%" onclick="generatePoem()">ğŸ“œ å‹‰å¼·ã®è»Œè·¡ã‚’ãƒã‚¨ãƒ ã«ã™ã‚‹</button>
                <div class="poem-display" id="poem-text"></div>
            </div>

            <button class="btn-theme" onclick="toggleTheme()">ğŸ¨ ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ</button>
            <div class="lap-list" id="laps"></div>

            <!-- åˆè¨€è‘‰ã‚’å…¥åŠ›ãƒ»å‡ºåŠ›ã™ã‚‹ãŸã‚ã®ã‚¨ãƒªã‚¢ -->
            <div class="magic-sync" style="margin-top: 30px; padding: 15px; border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 20px; background: rgba(255, 255, 255, 0.2)">
                <p style="font-size: 0.8rem; margin: 0 0 10px 0; color: var(--primary); font-weight: bold; text-align: center; opacity: 0.6">âœ¨ ãƒ‡ãƒ¼ã‚¿ã®å¼•ç¶™ãï¼ˆé­”æ³•ã®åˆè¨€è‘‰ï¼‰</p>
                <textarea
                    id="sync-text"
                    placeholder="ã“ã“ã«åˆè¨€è‘‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€æ›¸ãå‡ºã—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­"
                    style="width: 100%; height: 60px; font-size: 0.7rem; margin: 5px 0; opacity: 0.5; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; outline: none"
                ></textarea>
                <div style="display: flex; gap: 5px">
                    <button onclick="exportData()" style="flex: 1; font-size: 0.7rem">ğŸ“œ åˆè¨€è‘‰ã‚’ç”Ÿæˆ</button>
                    <button onclick="importData()" style="flex: 1; font-size: 0.7rem">ğŸ”® åˆè¨€è‘‰ã‚’å”±ãˆã‚‹</button>
                </div>
            </div>
        </div>

        <script>
            let startTime,
                timerInterval,
                isRunning = false;
            let elapsedTime = parseInt(localStorage.getItem("study-elapsedTime")) || 0;

            // --- å¤‰æ•°è¿½åŠ  ---
            let todayTotal = parseInt(localStorage.getItem("study-todayTotal")) || 0;
            let lastUpdateDate = localStorage.getItem("study-lastDate") || "";

            // 0æ™‚ã‹ã‚‰5æ™‚ã¯å¤œæ›´ã‹ã—ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹åˆ¤å®š
            function checkNightMode() {
                const hour = new Date().getHours();
                if (hour >= 0 && hour < 5) {
                    document.body.classList.add("blue-mode");
                }
            }

            // --- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®æ—¥ä»˜ãƒã‚§ãƒƒã‚¯ ---
            function checkNewDay() {
                const now = new Date();
                const todayStr = now.toLocaleDateString(); // "2023/10/27" å½¢å¼
                if (lastUpdateDate !== todayStr) {
                    todayTotal = 0; // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
                    localStorage.setItem("study-todayTotal", 0);
                    localStorage.setItem("study-lastDate", todayStr);
                }
            }

            // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«ä¿å­˜ã•ã‚Œã¦ã„ãŸæ™‚é–“ã‚’è¡¨ç¤ºã«åæ˜ ã•ã›ã‚‹
            const originalOnload = window.onload;
            window.onload = () => {
                checkNightMode(); // â˜…ã“ã‚Œã‚’è¿½åŠ ï¼šãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«å¤œãªã‚‰é’ãã™ã‚‹
                const formatted = formatTime(elapsedTime); // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ãŸæ™‚é–“ã‚’å–å¾—
                document.getElementById("display").textContent = formatted;
                document.title = `${formatted} - Study Timer`; // è¿½åŠ 
                updateProgressBar(); // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚‚ä¿å­˜æ™‚é–“ã«åˆã‚ã›ã‚‹
                if (originalOnload) originalOnload();
                checkNewDay();
                document.getElementById("today-total").textContent = formatTimeOnly(todayTotal);
            };

            const progressBar = document.getElementById("progressBar");
            const goalInput = document.getElementById("goalInput");
            const circ = 2 * Math.PI * 90;

            function update() {
                const now = Date.now();

                // --- æ—¥ä»˜ã¾ãŸãã®ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ  ---
                const todayStr = new Date().toLocaleDateString();
                if (lastUpdateDate !== "" && lastUpdateDate !== todayStr) {
                    // 1. æ˜¨æ—¥åˆ†ã®æœ€çµ‚åˆè¨ˆã‚’è¨ˆç®—ã—ã¦ãƒ©ãƒƒãƒ—ã«åˆ»ã‚€
                    const sessionDiffForLap = now - startTime;
                    const totalToRecord = todayTotal + sessionDiffForLap;

                    const item = document.createElement("div");
                    item.className = "lap-item";
                    item.style.borderLeft = "4px solid var(--accent)"; // æ—¥ä»˜ã¾ãŸãã®ç›®å°
                    item.innerHTML = `<span>ğŸ“… æ—¥ä»˜å¤‰æ›´è¨˜éŒ²</span> <strong>${formatTimeOnly(totalToRecord)}</strong>`;
                    laps.prepend(item);

                    elapsedTime += sessionDiffForLap; // â˜…é‡è¦ï¼šã“ã‚Œã¾ã§ã®çµŒéã‚’ä¿æŒã—ã¦æ•°å­—ã®å·»ãæˆ»ã‚Šã‚’é˜²ã

                    // 2. ãƒ‡ãƒ¼ã‚¿ã‚’ä»Šæ—¥ç”¨ã«ãƒªã‚»ãƒƒãƒˆ
                    todayTotal = 0;
                    lastUpdateDate = todayStr;
                    startTime = now; // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ç‚¹ã‚’0æ™‚ã«åˆã‚ã›ã‚‹

                    localStorage.setItem("study-elapsedTime", elapsedTime); // â˜…é‡è¦ï¼šä¿å­˜ã‚‚ã‚»ãƒƒãƒˆ
                    localStorage.setItem("study-todayTotal", 0);
                    localStorage.setItem("study-lastDate", todayStr);

                    createSparkles(); // æ—¥ä»˜å¤‰æ›´ã®é­”æ³•æ¼”å‡º
                    checkNightMode(); // å¤œæ›´ã‹ã—ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šã‚‚æ›´æ–°
                }

                const sessionDiff = now - startTime; // STARTã‚’æŠ¼ã—ã¦ã‹ã‚‰ä»Šã®ç¬é–“ã¾ã§ã®çµŒé
                const diff = sessionDiff + elapsedTime; // ä»Šå›ã®ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºç”¨ï¼ˆä¿å­˜ã•ã‚Œã¦ã„ãŸåˆ† + ä»Šå›ã®åˆ†ï¼‰
                const formatted = formatTime(diff);

                // 1. ã‚¿ã‚¤ãƒãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã®æ›´æ–°
                display.textContent = formatted;
                document.title = `${formatted} - Study Timer`; // ã‚¿ãƒ–ã®æ›´æ–°

                // 2. ã€Œä»Šæ—¥ã®åˆè¨ˆæ™‚é–“ã€ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
                // ä»Šæ—¥ã®åˆè¨ˆ = (å‰å›ä¿å­˜ã•ã‚ŒãŸä»Šæ—¥ã®åˆè¨ˆ) + (ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å¢—ãˆãŸåˆ†)
                const currentTodayTotal = todayTotal + sessionDiff;
                document.getElementById("today-total").textContent = formatTimeOnly(currentTodayTotal);

                // 3. é­”æ³•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
                updateMagicStatus(diff);
                localStorage.setItem("study-elapsedTime", diff);

                // 4. ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
                const goalMs = goalInput.value * 60000;
                const progress = Math.min(diff / goalMs, 1);
                progressBar.style.strokeDashoffset = circ - progress * circ;

                if (progress >= 1 && isRunning) {
                    celebrate();
                }
            }

            function celebrate() {
                playSE("https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"); // ç›®æ¨™é”æˆå¾Œã¯å°‘ã—è‰²ã‚’å¤‰ãˆã‚‹ãªã©æ¼”å‡º
            }

            function formatTime(ms) {
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                const s = Math.floor((ms % 60000) / 1000);
                const msPart = Math.floor((ms % 1000) / 10);

                if (h > 0) {
                    // 1æ™‚é–“ä»¥ä¸Šã®æ™‚ã¯ãƒŸãƒªç§’ã‚’çœãã¨ã‚¹ãƒƒã‚­ãƒªåã¾ã‚Šã¾ã™
                    return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
                } else {
                    return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}.${String(msPart).padStart(2, "0")}`;
                }
            }

            function toggleTimer() {
                if (!isRunning) {
                    checkNewDay(); // é–‹å§‹æ™‚ã«ã‚‚ä¸€å¿œãƒã‚§ãƒƒã‚¯
                    checkNightMode(); // â˜…ã“ã“ã«è¿½åŠ ï¼å¤œãªã‚‰è‡ªå‹•ã§ãƒ–ãƒ«ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«
                    isRunning = true;
                    startTime = Date.now();
                    timerInterval = setInterval(update, 10);
                    startBtn.textContent = "STOP";

                    // â˜… çµµæ–‡å­—é£›ã°ã™ï¼
                    burstEmoji();
                    playSE("https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3");
                } else {
                    isRunning = false;
                    // 1. ä»Šå›ã®å‹‰å¼·æ™‚é–“ã‚’è¨ˆç®—
                    const currentSession = Date.now() - startTime;
                    // 2. ãã®æ™‚é–“ã‚’ãã‚Œãã‚Œã®åˆè¨ˆã«è¶³ã™
                    elapsedTime += currentSession;
                    todayTotal += currentSession;

                    clearInterval(timerInterval);
                    startBtn.textContent = "START";

                    // ä¿å­˜
                    localStorage.setItem("study-elapsedTime", elapsedTime);
                    localStorage.setItem("study-todayTotal", todayTotal);
                }
            }

            // --- æ™‚ãƒ»åˆ†ãƒ»ç§’ ã ã‘ã‚’ç¶ºéº—ã«å‡ºã™é–¢æ•° ---
            function formatTimeOnly(ms) {
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                const s = Math.floor((ms % 60000) / 1000);
                return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
            }

            function resetTimer() {
                if (!confirm("å‹‰å¼·æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

                isRunning = false;
                clearInterval(timerInterval);
                elapsedTime = 0;
                // â˜… ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚‚ 0 ã«ã™ã‚‹
                localStorage.setItem("study-elapsedTime", 0);

                display.textContent = "00:00.00";
                document.title = "00:00.00 - Study Timer"; // ã‚¿ãƒ–ã‚‚ãƒªã‚»ãƒƒãƒˆ
                progressBar.style.strokeDashoffset = circ;
                document.getElementById("laps").innerHTML = "";
            }

            // å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚»ãƒƒãƒˆ
            function resetAllMagicData() {
                if (!confirm("ã“ã‚Œã¾ã§ã®å­¦ç¿’ãƒ¬ãƒ™ãƒ«ã‚„ã€ãŠåº­ã®èŠ±ã‚‚ã™ã¹ã¦æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

                // 1. localStorageã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆå»
                localStorage.removeItem("study-elapsedTime");
                localStorage.removeItem("study-todayTotal");
                localStorage.removeItem("magic-exp");
                localStorage.removeItem("magic-garden");
                localStorage.removeItem("study-lastDate");

                // 2. JavaScriptå†…ã®å¤‰æ•°ã‚’åˆæœŸåŒ–
                elapsedTime = 0;
                todayTotal = 0;
                exp = 0;
                flowers = [];

                // 3. ç”»é¢è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                display.textContent = "00:00.00";
                document.title = "00:00.00 - Study Timer";
                document.getElementById("today-total").textContent = "00:00:00";
                document.getElementById("lv-focus").textContent = "1";
                document.getElementById("exp-knowledge").textContent = "0";
                document.getElementById("laps").innerHTML = "";

                updateProgressBar();
                renderGarden();

                alert("ã™ã¹ã¦ã®é­”åŠ›ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€æ–°ã—ã„æ—…ãŒå§‹ã¾ã‚Šã¾ã™ã€‚");
            }

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®åˆæœŸåŒ–ç”¨é–¢æ•°
            function updateProgressBar() {
                const goalMs = goalInput.value * 60000;
                const progress = Math.min(elapsedTime / goalMs, 1);
                progressBar.style.strokeDashoffset = circ - progress * circ;
            }

            function recordLap() {
                const current = isRunning ? Date.now() - startTime + elapsedTime : elapsedTime;
                const item = document.createElement("div");
                item.className = "lap-item";
                item.innerHTML = `<span>Lap ${laps.children.length + 1}</span> <strong>${formatTime(current)}</strong>`;
                laps.prepend(item);
            }

            function toggleTheme() {
                document.body.classList.toggle("blue-mode");
            }

            function createSparkles() {
                for (let i = 0; i < 15; i++) {
                    const s = document.createElement("div");
                    s.className = "sparkle";
                    s.style.setProperty("--x", (Math.random() - 0.5) * 300 + "px");
                    s.style.setProperty("--y", (Math.random() - 0.5) * 300 + "px");
                    s.style.left = "50%";
                    s.style.top = "50%";
                    document.querySelector(".container").appendChild(s);
                    setTimeout(() => s.remove(), 800);
                }
            }

            function playSE(url) {
                new Audio(url).play();
            }

            // --- è¿½åŠ æ©Ÿèƒ½ã®ãƒ‡ãƒ¼ã‚¿ã¨é–¢æ•° ---

            // 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚¬ãƒ¼ãƒ‡ãƒ³ã®ãƒ‡ãƒ¼ã‚¿
            let exp = parseInt(localStorage.getItem("magic-exp")) || 0;
            let flowers = JSON.parse(localStorage.getItem("magic-garden")) || [];

            // 2. é­”æ³•ã®æ°´æ™¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒœã‚¤ã‚¹ã®ä»£ã‚ã‚Šï¼‰
            // æ˜¼ã¨å¤œã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†ã‘ã‚‹
            const messagesDay = [
                "ä»Šã®å›ã®é›†ä¸­åŠ›ã€éŠ€æ²³ä¸€ã ã‚ˆï¼",
                "é­”æ³•ã®ç²’å­ãŒé›†ã¾ã£ã¦ããŸã­ã€ã‚ã¨å°‘ã—ï¼",
                "é‹å‘½ã¯åŠªåŠ›ã™ã‚‹è€…ã«å¾®ç¬‘ã‚€ã‚“ã ã€‚",
                "æœªæ¥ã®å›ãŒã€ã‚ã‚ŠãŒã¨ã†ã€ã£ã¦è¨€ã£ã¦ã‚‹ã‚ˆã€‚",
                "ä¸€æ­©ãšã¤ã€ç¢ºå®Ÿã«ã€‚å›ã¯æˆé•·ã—ã¦ã„ã‚‹ã‚ˆã€‚",
            ];

            const messagesNight = [
                "é™ã‹ãªå¤œã ã­ã€‚å›ã®åŠªåŠ›ãŒæ˜Ÿã®ã‚ˆã†ã«è¼ã„ã¦ã‚‹ã‚ˆã€‚",
                "å¤œæ›´ã‹ã—ã®é­”æ³•ä½¿ã„ã•ã‚“ã€ç„¡ç†ã¯ç¦ç‰©ã ã‚ˆï¼Ÿ",
                "ã“ã®é™å¯‚ã¯ã€å›ãŒçŸ¥è­˜ã‚’å¸åã™ã‚‹ãŸã‚ã®ã‚®ãƒ•ãƒˆã ã‚ˆã€‚",
                "æ·±å¤œã®é›†ä¸­åŠ›ã¯ã€ç‰¹åˆ¥ãªé­”åŠ›ã‚’ç§˜ã‚ã¦ã„ã‚‹ã‚“ã ã€‚",
                "ãã‚ãã‚æ¸©ã‹ã„é£²ã¿ç‰©ã§ã‚‚ã©ã†ï¼Ÿé­”æ³•åŠ¹ç‡ãŒä¸ŠãŒã‚‹ã‚ˆã€‚",
            ];

            function touchCrystal() {
                const hour = new Date().getHours();
                let msgList;

                // 0æ™‚ã€œ5æ™‚ãªã‚‰å¤œæ›´ã‹ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãã‚Œä»¥å¤–ã¯æ˜¼ç”¨
                if (hour >= 0 && hour < 5) {
                    msgList = messagesNight;
                } else {
                    msgList = messagesDay;
                }

                const msg = msgList[Math.floor(Math.random() * msgList.length)];
                document.getElementById("crystal-msg").textContent = msg;
                createSparkles(); // æ—¢å­˜ã®ã‚­ãƒ©ã‚­ãƒ©æ¼”å‡ºã‚’æµç”¨
                playSE("https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3");
            }

            // 3. ã‚¬ãƒ¼ãƒ‡ãƒ³ã¨ãƒ¬ãƒ™ãƒ«ã®æ›´æ–°ï¼ˆæ—¢å­˜ã®updateé–¢æ•°ã‹ã‚‰å‘¼ã³å‡ºã™æƒ³å®šï¼‰
            function updateMagicStatus(diffMs) {
                // 1åˆ†ã”ã¨ã«1EXP
                const newExp = Math.floor(diffMs / 60000);
                if (newExp > exp) {
                    exp = newExp;
                    document.getElementById("lv-focus").textContent = Math.floor(exp / 10) + 1;
                    document.getElementById("exp-knowledge").textContent = exp;
                    localStorage.setItem("magic-exp", exp);

                    // 60åˆ†ã”ã¨ã«èŠ±ãŒå’²ã
                    const flowerCount = Math.floor(exp / 60);
                    if (flowerCount > flowers.length) {
                        flowers.push("ğŸŒ¸");
                        localStorage.setItem("magic-garden", JSON.stringify(flowers));
                        renderGarden();
                    }
                }
            }

            function renderGarden() {
                const garden = document.getElementById("garden");
                garden.textContent = flowers.length > 0 ? flowers.join("") : "ğŸŒ±";
            }

            // 4. ãƒã‚¨ãƒ ãƒ»ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼
            function generatePoem() {
                const lines = [
                    `é™å¯‚ã®ä¸­ã«åˆ»ã¾ã‚Œã‚‹ ${formatTime(elapsedTime)} ã®é¼“å‹•...`,
                    `çŸ¥è­˜ã¨ã„ã†åã®æ˜Ÿå±‘ã‚’ã€å›ã¯ä»Šã€æ‰‹ä¸­ã«åã‚ãŸã€‚`,
                    `ç›®æ¨™ ${goalInput.value} åˆ†ã®å£ã‚’è¶…ãˆã€ç†ï¼ˆã“ã¨ã‚ã‚Šï¼‰ã¯æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ã€‚`,
                    `çœ ã‚Œã‚‹çŸ¥æ€§ãŒç›®è¦šã‚ã‚‹æ™‚ã€ä¸–ç•Œã¯é®®ã‚„ã‹ã«å½©ã‚‰ã‚Œã‚‹ã ã‚ã†ã€‚`,
                ];
                document.getElementById("poem-text").textContent = lines[Math.floor(Math.random() * lines.length)];
            }

            // åˆæœŸåŒ–æ™‚ã«å®Ÿè¡Œ
            renderGarden();
            document.getElementById("exp-knowledge").textContent = exp;
            document.getElementById("lv-focus").textContent = Math.floor(exp / 10) + 1;

            // 1. ã™ã¹ã¦ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€ã¤ã®ã€Œåˆè¨€è‘‰ã€ã«ã¾ã¨ã‚ã‚‹
            function exportData() {
                const studyData = {
                    elapsedTime: localStorage.getItem("study-elapsedTime") || "0",
                    exp: localStorage.getItem("magic-exp") || "0",
                    garden: localStorage.getItem("magic-garden") || "[]",
                };

                // ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡å­—åˆ—ã«ã—ã¦ã€åˆè¨€è‘‰ï¼ˆBase64ï¼‰ã«å¤‰æ›
                const combinedData = JSON.stringify(studyData);
                const spell = btoa(unescape(encodeURIComponent(combinedData)));

                document.getElementById("sync-text").value = spell;
                document.getElementById("sync-text").select();
                document.execCommand("copy");
                alert("å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ã€Œé­”æ³•ã®åˆè¨€è‘‰ã€ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼ğŸŒ¸");
            }

            // 2. ã€Œåˆè¨€è‘‰ã€ã‚’èª­ã¿è¾¼ã‚“ã§ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
            function importData() {
                const spell = document.getElementById("sync-text").value.trim();
                if (!spell) {
                    alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
                    return;
                }

                try {
                    const decodedData = decodeURIComponent(escape(atob(spell)));
                    const parsed = JSON.parse(decodedData);

                    if (confirm("ã“ã‚Œã¾ã§ã®å­¦ç¿’è¨˜éŒ²ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã‘ã©å¤§ä¸ˆå¤«ï¼Ÿ")) {
                        // å„ãƒ‡ãƒ¼ã‚¿ã‚’ãã‚Œãã‚Œã®ã‚­ãƒ¼ã§ä¿å­˜ã—ç›´ã™
                        localStorage.setItem("study-elapsedTime", parsed.elapsedTime);
                        localStorage.setItem("magic-exp", parsed.exp);
                        localStorage.setItem("magic-garden", parsed.garden);

                        alert("åŒæœŸãŒå®Œäº†ã—ãŸã‚ˆï¼ç©ã¿ä¸Šã’ãŸåŠªåŠ›ãŒå¾©å…ƒã•ã‚Œã¾ã—ãŸğŸŒˆ");
                        location.reload();
                    }
                } catch (e) {
                    alert("åˆè¨€è‘‰ãŒé­”æ³•ã®å½¢å¼ã˜ã‚ƒãªã„ã¿ãŸã„ã€‚ã‚³ãƒ”ãƒ¼ã‚’ç¢ºèªã—ã¦ã­ï¼");
                }
            }

            function burstEmoji() {
                const isBlue = document.body.classList.contains("blue-mode");
                // ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦çµµæ–‡å­—ã‚’åˆ‡ã‚Šæ›¿ãˆ
                const emojis = isBlue ? ["ğŸ©µ", "ğŸª¼", "ğŸª½", "ğŸ’", "â„ï¸", "ğŸ§Š", "ğŸ¬", "ğŸ³"] : ["ğŸŒ¸", "âœ¨", "ğŸ’–", "ğŸ€", "ğŸŒ·", "ğŸ­", "ğŸŒˆ", "ğŸ¦„"];

                const container = document.querySelector(".container");
                const btn = document.getElementById("startBtn");
                const rect = btn.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();

                // 12å€‹ã®çµµæ–‡å­—ã‚’é£›ã°ã™
                for (let i = 0; i < 12; i++) {
                    const p = document.createElement("div");
                    p.className = "particle";
                    p.textContent = emojis[Math.floor(Math.random() * emojis.length)];

                    // ãƒœã‚¿ãƒ³ã®ä¸­å¿ƒä»˜è¿‘ã‹ã‚‰ç™ºç”Ÿã•ã›ã‚‹
                    const x = rect.left - containerRect.left + rect.width / 2;
                    const y = rect.top - containerRect.top + rect.height / 2;
                    p.style.left = x + "px";
                    p.style.top = y + "px";

                    // â˜… é£›è·é›¢ã‚’ 200px ã‹ã‚‰ 400px ã«å¼·åŒ–ï¼
                    // ä¸Šä¸‹å·¦å³ã«æœ€å¤§ 200px ãšã¤ï¼ˆåˆè¨ˆ 400px ã®ç¯„å›²ï¼‰é£›ã³æ•£ã‚Šã¾ã™
                    const angle = Math.random() * Math.PI * 2; // å…¨æ–¹å‘ã«å‡ç­‰ã«æ•£ã‚‰ã™
                    const distance = 100 + Math.random() * 250; // é£›ã¶è·é›¢ã‚’ 100ã€œ350px ã®é–“ã§ãƒ©ãƒ³ãƒ€ãƒ ã«

                    // é£›ã³æ•£ã‚‹æ–¹å‘ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
                    p.style.setProperty("--mx", (Math.random() - 0.5) * 200 + "px");
                    p.style.setProperty("--my", (Math.random() - 0.5) * 200 + "px");
                    p.style.setProperty("--rt", Math.random() * 360 + "deg");

                    container.appendChild(p);
                    setTimeout(() => p.remove(), 1200);
                }
            }
        </script>
    </body>
</html>
