<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Japan Cafe Master | Edit & Delete</title>
        <script async src="//www.instagram.com/embed.js"></script>
        <style>
            :root {
                --cafe-dark: #8d6e63;
                --cafe-light: #d7ccc8;
                --cafe-latte: #bcaaa4;
                --pink: #ff71ee;
                --purple: #c186ff;
                --blue: #a7ccff;
                --yellow: #f8ffae;
                --mint: #89ffc4;
                --gold: #ffd700;
                --red: #ff8a80;
            }

            body {
                background-color: #fdfaf7;
                margin: 0;
                font-family: "Arial Rounded MT Bold", sans-serif;
                color: #5d4037;
            }

            header {
                background: linear-gradient(135deg, var(--cafe-latte), var(--cafe-dark));
                padding: 4rem 1rem;
                color: white;
                text-align: center;
                clip-path: ellipse(120% 80% at 50% 20%);
            }

            header h1 {
                font-size: 3rem;
                margin: 0;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            }

            nav {
                display: flex;
                justify-content: center;
                gap: 15px;
                margin: -25px auto 30px;
                position: relative;
                z-index: 10;
            }

            .nav-btn {
                padding: 12px 25px;
                border-radius: 50px;
                border: none;
                background: white;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                font-weight: bold;
                color: var(--cafe-dark);
                display: flex;
                align-items: center;
                gap: 8px;
                transition: 0.3s;
            }

            .nav-btn.active {
                background: var(--mint);
                color: #2e7d32;
            }

            .map-section {
                max-width: 900px;
                margin: 0 auto 40px;
                padding: 25px;
                background: white;
                border-radius: 30px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            }

            .grid-map {
                display: grid;
                grid-template-columns: repeat(11, 1fr);
                gap: 6px;
                max-width: 600px;
                margin: 0 auto;
            }

            .pref-btn {
                aspect-ratio: 1;
                border: none;
                border-radius: 6px;
                background-color: var(--blue);
                color: white;
                font-size: 10px;
                font-weight: bold;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2px;
                transition: 0.2s;
            }

            /* ã‚¹ãƒãƒ›ï¼ˆç”»é¢å¹…ãŒç‹­ã„æ™‚ï¼‰å°‚ç”¨ã®èª¿æ•´ */
            @media (max-width: 600px) {
                .grid-map {
                    gap: 3px; /* ãƒã‚¹ç›®ã®éš™é–“ã‚’ç‹­ãã™ã‚‹ */
                    padding: 5px;
                }

                .pref-btn {
                    font-size: 8px; /* æ–‡å­—ã‚’å°ã•ãã—ã¦åã‚ã‚‹ */
                    border-radius: 4px;
                    padding: 0;
                    white-space: nowrap; /* æ–‡å­—ã®æŠ˜ã‚Šè¿”ã—ã‚’é˜²ã */
                }
            }

            .pref-btn.complete {
                background: linear-gradient(45deg, var(--gold), #ff9900);
                color: #5d4a00;
            }

            .pref-btn.active {
                background-color: var(--cafe-dark);
                color: white;
            }

            .pref-btn.empty {
                background: transparent;
            }

            .add-form-section {
                max-width: 900px;
                margin: 0 auto 40px;
                padding: 25px;
                background: white;
                border-radius: 20px;
                border: 3px dashed var(--cafe-light);
                text-align: center;
            }

            .add-form-section input {
                padding: 12px;
                border: 1px solid #efebe9;
                border-radius: 10px;
                margin: 5px;
                background: #fafafa;
                width: 220px;
            }

            #display-section {
                max-width: 1000px;
                margin: 0 auto 100px;
                padding: 0 20px;
                text-align: center;
            }

            .pref-title {
                color: var(--cafe-dark);
                border-bottom: 4px dotted var(--cafe-latte);
                display: inline-block;
                margin-bottom: 30px;
            }

            .cafe-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 30px;
            }

            .cafe-card {
                background: white;
                border-radius: 25px;
                overflow: hidden;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
                position: relative;
                border: 2px solid transparent;
                transition: 0.3s;
                padding-bottom: 20px;
            }

            .cafe-card.visited {
                border-color: var(--mint);
                background-color: #f1fcf6;
            }

            .insta-embed-container {
                width: 100%;
                min-height: 300px;
                background: #f0f0f0;
                overflow: hidden;
            }

            .cafe-info {
                padding: 20px;
                text-align: left;
            }

            .cafe-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .cafe-header h3 {
                margin: 0;
                font-size: 1.3rem;
            }

            /* ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ */
            .action-btns {
                display: flex;
                gap: 8px;
            }

            .action-icon {
                cursor: pointer;
                font-size: 1.1rem;
                border: none;
                background: none;
                padding: 5px;
                border-radius: 5px;
                transition: 0.2s;
            }

            .action-icon:hover {
                background: rgba(0, 0, 0, 0.05);
            }

            .edit-icon:hover {
                color: var(--blue);
            }

            .delete-icon:hover {
                color: var(--red);
            }

            .memo-area {
                margin-top: 15px;
                padding: 15px;
                background: var(--yellow);
                border-radius: 15px;
                font-size: 0.85rem;
            }

            .memo-input {
                width: 100%;
                border: 1px solid rgba(0, 0, 0, 0.05);
                border-radius: 10px;
                padding: 10px;
                font-family: inherit;
                margin-top: 8px;
                min-height: 80px;
                box-sizing: border-box;
            }

            .btn-group {
                display: flex;
                gap: 12px;
                margin-top: 20px;
                padding: 0 20px;
            }

            .insta-btn {
                flex: 1;
                padding: 12px;
                background: linear-gradient(45deg, #f09433, #bc1888);
                color: white;
                text-decoration: none;
                border-radius: 12px;
                text-align: center;
                font-size: 0.85rem;
                font-weight: bold;
            }

            .check-btn {
                padding: 10px 20px;
                border: 2px solid var(--mint);
                background: white;
                color: #2e7d32;
                border-radius: 12px;
                cursor: pointer;
                font-weight: bold;
            }

            .visited .check-btn {
                background: var(--mint);
                color: white;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Japan Cafe Master âœ¨</h1>
            <p>ã‚ãªãŸã ã‘ã®ã‚«ãƒ•ã‚§å›³é‘‘ã€è‡ªç”±ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€‚</p>
        </header>

        <nav>
            <button class="nav-btn active" id="mode-map" onclick="setMode('map')">ğŸ—ºï¸ ãƒ¢ãƒ¼ãƒ‰ map</button>
            <button class="nav-btn" id="mode-history" onclick="setMode('history')">âœ… è¡Œã£ãŸãƒªã‚¹ãƒˆ</button>
        </nav>

        <div class="map-section" id="map-area">
            <div class="grid-map" id="japan-map"></div>
        </div>

        <div class="add-form-section" id="form-area">
            <h3>âœ¨ ã‚«ãƒ•ã‚§ã‚’è¿½åŠ </h3>
            <input type="text" id="new-cafe-name" placeholder="ã‚«ãƒ•ã‚§ã®åå‰" />
            <input type="text" id="new-cafe-insta" placeholder="Instagram æŠ•ç¨¿URL" />
            <button class="nav-btn" style="background: var(--cafe-dark); color: white; display: inline-flex; margin-left: 10px" onclick="addNewCafe()">è¿½åŠ </button>
        </div>

        <div id="display-section">
            <h2 class="pref-title" id="display-title">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <div class="cafe-grid" id="cafe-list"></div>
        </div>

        <div
            class="sync-section"
            style="
                max-width: 400px;
                margin: 40px auto;
                padding: 15px;
                background: rgba(255, 255, 255, 0.4);
                border: 1px solid rgba(141, 110, 99, 0.2);
                border-radius: 20px;
                text-align: center;
            "
        >
            <p style="font-size: 0.75rem; font-weight: bold; opacity: 0.6; margin-bottom: 8px">ğŸ“± ã‚¹ãƒãƒ›ã¨åŒæœŸï¼ˆé­”æ³•ã®åˆè¨€è‘‰ï¼‰</p>
            <textarea>
                id="sync-text"
                placeholder="ã“ã“ã«åˆè¨€è‘‰ã‚’è²¼ã‚‹ã‹ã€ç”Ÿæˆã—ã¦ã­"
                style="width: 100%; height: 50px; font-size: 0.7rem; border-radius: 10px; border: 1px solid #ddd; padding: 5px; opacity: 0.6"
            </textarea>
            <div style="display: flex; gap: 5px; margin-top: 8px">
                <button
                    onclick="exportData()"
                    style="flex: 1; font-size: 0.7rem; padding: 8px; border-radius: 10px; border: none; background: var(--cafe-latte); color: white; cursor: pointer"
                >
                    ğŸ“œ åˆè¨€è‘‰ã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button
                    onclick="importData()"
                    style="flex: 1; font-size: 0.7rem; padding: 8px; border-radius: 10px; border: none; background: var(--mint); color: #2e7d32; cursor: pointer"
                >
                    ğŸ”® åŒæœŸã‚’å®Ÿè¡Œ
                </button>
            </div>
        </div>

        <script>
            // åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’11åˆ—ã®ã‚°ãƒªãƒƒãƒ‰ã«æœ€é©åŒ–
            const prefList = [
                { id: "hokkaido", name: "åŒ—æµ·é“", x: 10, y: 0 },
                { id: "aomori", name: "é’æ£®", x: 10, y: 1 },
                { id: "iwate", name: "å²©æ‰‹", x: 10, y: 2 },
                { id: "miyagi", name: "å®®åŸ", x: 10, y: 3 },
                { id: "akita", name: "ç§‹ç”°", x: 9, y: 1 },
                { id: "yamagata", name: "å±±å½¢", x: 9, y: 2 },
                { id: "fukushima", name: "ç¦å³¶", x: 9, y: 3 },
                { id: "ibaraki", name: "èŒ¨åŸ", x: 9, y: 4 },
                { id: "tochigi", name: "æ ƒæœ¨", x: 8, y: 4 },
                { id: "gunma", name: "ç¾¤é¦¬", x: 7, y: 4 },
                { id: "saitama", name: "åŸ¼ç‰", x: 8, y: 5 },
                { id: "chiba", name: "åƒè‘‰", x: 9, y: 5 },
                { id: "tokyo", name: "æ±äº¬", x: 8, y: 6 },
                { id: "kanagawa", name: "ç¥å¥ˆå·", x: 7, y: 6 },
                { id: "niigata", name: "æ–°æ½Ÿ", x: 8, y: 3 },
                { id: "toyama", name: "å¯Œå±±", x: 7, y: 3 },
                { id: "ishikawa", name: "çŸ³å·", x: 6, y: 3 },
                { id: "fukui", name: "ç¦äº•", x: 5, y: 3 },
                { id: "yamanashi", name: "å±±æ¢¨", x: 6, y: 4 },
                { id: "nagano", name: "é•·é‡", x: 6, y: 5 },
                { id: "gifu", name: "å²é˜œ", x: 5, y: 4 },
                { id: "shizuoka", name: "é™å²¡", x: 6, y: 6 },
                { id: "aichi", name: "æ„›çŸ¥", x: 5, y: 5 },
                { id: "mie", name: "ä¸‰é‡", x: 5, y: 6 },
                { id: "shiga", name: "æ»‹è³€", x: 4, y: 4 },
                { id: "kyoto", name: "äº¬éƒ½", x: 4, y: 5 },
                { id: "osaka", name: "å¤§é˜ª", x: 3, y: 5 },
                { id: "hyogo", name: "å…µåº«", x: 3, y: 4 },
                { id: "nara", name: "å¥ˆè‰¯", x: 4, y: 6 },
                { id: "wakayama", name: "å’Œæ­Œå±±", x: 3, y: 6 },
                { id: "tottori", name: "é³¥å–", x: 2, y: 3 },
                { id: "shimane", name: "å³¶æ ¹", x: 1, y: 3 },
                { id: "okayama", name: "å²¡å±±", x: 2, y: 4 },
                { id: "hiroshima", name: "åºƒå³¶", x: 1, y: 4 },
                { id: "yamaguchi", name: "å±±å£", x: 1, y: 5 },
                { id: "tokushima", name: "å¾³å³¶", x: 2, y: 6 },
                { id: "kagawa", name: "é¦™å·", x: 2, y: 5 },
                { id: "ehime", name: "æ„›åª›", x: 1, y: 6 },
                { id: "kochi", name: "é«˜çŸ¥", x: 1, y: 7 },
                { id: "fukuoka", name: "ç¦å²¡", x: 2, y: 7 },
                { id: "saga", name: "ä½è³€", x: 2, y: 8 },
                { id: "nagasaki", name: "é•·å´", x: 1, y: 8 },
                { id: "kumamoto", name: "ç†Šæœ¬", x: 2, y: 9 },
                { id: "oita", name: "å¤§åˆ†", x: 3, y: 8 },
                { id: "miyazaki", name: "å®®å´", x: 3, y: 9 },
                { id: "kagoshima", name: "é¹¿å…å³¶", x: 2, y: 10 },
                { id: "okinawa", name: "æ²–ç¸„", x: 1, y: 10 },
            ];

            let cafeData = JSON.parse(localStorage.getItem("myCafeData")) || {};
            let visitedList = JSON.parse(localStorage.getItem("visitedCafes")) || [];
            let memoData = JSON.parse(localStorage.getItem("cafeMemos")) || {};
            let currentMode = "map";
            let currentPrefId = "";

            // åŒæœŸæ©Ÿèƒ½ï¼šã“ã“ã‚’è¿½åŠ 
            function exportData() {
                const fullData = {
                    cafeData: cafeData,
                    visitedList: visitedList,
                    memoData: memoData,
                };
                // 3ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ã«ã¾ã¨ã‚ã¦Base64å¤‰æ›
                const combined = JSON.stringify(fullData);
                const spell = btoa(unescape(encodeURIComponent(combined)));

                document.getElementById("sync-text").value = spell;
                document.getElementById("sync-text").select();
                document.execCommand("copy");
                alert("ã‚«ãƒ•ã‚§å›³é‘‘ã®ã€Œé­”æ³•ã®åˆè¨€è‘‰ã€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼â˜•\nã‚¹ãƒãƒ›ã®ã“ã®æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
            }

            function importData() {
                const spell = document.getElementById("sync-text").value.trim();
                if (!spell) return alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");

                try {
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(spell))));
                    if (confirm("ä»Šã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                        // å„ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¿å­˜
                        localStorage.setItem("myCafeData", JSON.stringify(decoded.cafeData));
                        localStorage.setItem("visitedCafes", JSON.stringify(decoded.visitedList));
                        localStorage.setItem("cafeMemos", JSON.stringify(decoded.memoData));

                        alert("åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼ğŸŒˆ");
                        location.reload(); // ç”»é¢ã‚’æ›´æ–°ã—ã¦åæ˜ 
                    }
                } catch (e) {
                    alert("åˆè¨€è‘‰ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™ã€‚æ­£ã—ãã‚³ãƒ”ãƒ¼ã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            }

            function renderMap() {
                const mapContainer = document.getElementById("japan-map");
                mapContainer.innerHTML = "";

                // 11è¡Œ x 11åˆ—ã®ç©ºãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const grid = Array(11)
                    .fill(null)
                    .map(() => Array(11).fill(null));

                // éƒ½é“åºœçœŒã‚’åº§æ¨™ã«é…ç½®
                prefList.forEach((p) => {
                    grid[p.y][p.x] = p;
                });

                // HTMLã‚’ç”Ÿæˆï¼ˆã“ã“ãŒ11åˆ—ãƒ«ãƒ¼ãƒ—ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªï¼ï¼‰
                for (let y = 0; y < 11; y++) {
                    for (let x = 0; x < 11; x++) {
                        const p = grid[y][x];
                        const btn = document.createElement("div");

                        if (p) {
                            btn.className = "pref-btn" + (currentPrefId === p.id ? " active" : "");
                            btn.textContent = p.name;
                            btn.onclick = () => selectPref(p.id, p.name);

                            const cafes = cafeData[p.id] || [];
                            if (cafes.length > 0 && cafes.every((c) => visitedList.includes(c.id))) {
                                btn.classList.add("complete");
                            }
                        } else {
                            btn.className = "pref-btn empty";
                        }
                        mapContainer.appendChild(btn);
                    }
                }
            }

            function setMode(mode) {
                currentMode = mode;
                document.querySelectorAll(".nav-btn").forEach((b) => b.classList.remove("active"));
                document.getElementById(`mode-${mode}`).classList.add("active");
                if (mode === "history") {
                    document.getElementById("map-area").style.display = "none";
                    document.getElementById("form-area").style.display = "none";
                    document.getElementById("display-title").textContent = "âœ… è¡Œã£ãŸãƒªã‚¹ãƒˆ";
                    renderHistory();
                } else {
                    document.getElementById("map-area").style.display = "block";
                    document.getElementById("form-area").style.display = "block";
                    document.getElementById("display-title").textContent = currentPrefId
                        ? `ğŸ“ ${prefList.find((p) => p.id === currentPrefId).name} ã®ã‚«ãƒ•ã‚§`
                        : "éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„";
                    renderCafes();
                }
            }

            function selectPref(id, name) {
                currentPrefId = id;
                document.getElementById("display-title").textContent = `ğŸ“ ${name} ã®ã‚«ãƒ•ã‚§`;
                renderMap();
                renderCafes();
            }

            function renderCafes() {
                const list = document.getElementById("cafe-list");
                list.innerHTML = "";
                const cafes = cafeData[currentPrefId] || [];
                cafes.forEach((cafe) => list.appendChild(createCard(cafe)));
                if (window.instgrm) window.instgrm.Embeds.process();
            }

            function renderHistory() {
                const list = document.getElementById("cafe-list");
                list.innerHTML = "";
                Object.values(cafeData)
                    .flat()
                    .forEach((cafe) => {
                        if (visitedList.includes(cafe.id)) list.appendChild(createCard(cafe));
                    });
                if (window.instgrm) window.instgrm.Embeds.process();
            }

            function createCard(cafe) {
                const isVisited = visitedList.includes(cafe.id);
                const memo = memoData[cafe.id] || "";
                const card = document.createElement("div");
                card.className = `cafe-card ${isVisited ? "visited" : ""}`;

                const cleanUrl = cafe.insta.split("?")[0];

                card.innerHTML = `
            <div class="insta-embed-container">
                <blockquote class="instagram-media" data-instgrm-permalink="${cleanUrl}" data-instgrm-version="14" style="width:100%; border:0; margin:0;"></blockquote>
            </div>
            <div class="cafe-info">
                <div class="cafe-header">
                    <h3><span>${isVisited ? "âœ…" : "ğŸ“"}</span> ${cafe.name}</h3>
                    <div class="action-btns">
                        <button class="action-icon edit-icon" title="ç·¨é›†" onclick="editCafe('${cafe.id}')">âœï¸</button>
                        <button class="action-icon delete-icon" title="å‰Šé™¤" onclick="deleteCafe('${cafe.id}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="memo-area">
                    <strong>ğŸ’­ MEMO:</strong>
                    <textarea class="memo-input" id="memo-${cafe.id}" onchange="saveMemo('${cafe.id}', this.value)">${memo}</textarea>
                </div>
            </div>
            <div class="btn-group">
                <a href="${cafe.insta}" target="_blank" class="insta-btn">Instagramã‚’é–‹ã</a>
                <button class="check-btn" onclick="toggleVisit('${cafe.id}')">${isVisited ? "è¡Œã£ãŸï¼" : "è¡Œãï¼"}</button>
            </div>
        `;
                return card;
            }

            // åŒæœŸæ©Ÿèƒ½
            function exportData() {
                const fullData = {
                    cafeData: cafeData,
                    visitedList: visitedList,
                    memoData: memoData,
                };
                const spell = btoa(unescape(encodeURIComponent(JSON.stringify(fullData))));
                document.getElementById("sync-text").value = spell;
                document.getElementById("sync-text").select();
                document.execCommand("copy");
                alert("ã‚«ãƒ•ã‚§å›³é‘‘ã®åˆè¨€è‘‰ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼ã‚¹ãƒãƒ›ã«é€ã£ã¦ã­ã€‚â˜•");
            }

            function importData() {
                const spell = document.getElementById("sync-text").value.trim();
                if (!spell) return alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
                try {
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(spell))));
                    if (confirm("ä»Šã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã‘ã©å¤§ä¸ˆå¤«ï¼Ÿ")) {
                        localStorage.setItem("myCafeData", JSON.stringify(decoded.cafeData));
                        localStorage.setItem("visitedCafes", JSON.stringify(decoded.visitedList));
                        localStorage.setItem("cafeMemos", JSON.stringify(decoded.memoData));
                        alert("é­”æ³•ãŒæˆåŠŸã—ãŸã‚ˆï¼åŒæœŸå®Œäº†ã€‚");
                        location.reload();
                    }
                } catch (e) {
                    alert("åˆè¨€è‘‰ãŒé•ã†ã¿ãŸã„â€¦");
                }
            }

            // --- æ–°è¦è¿½åŠ æ©Ÿèƒ½: ç·¨é›† & å‰Šé™¤ ---
            window.editCafe = function (cafeId) {
                // ã‚«ãƒ•ã‚§ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
                let targetPref = "";
                let targetIndex = -1;
                for (let prefId in cafeData) {
                    targetIndex = cafeData[prefId].findIndex((c) => c.id === cafeId);
                    if (targetIndex !== -1) {
                        targetPref = prefId;
                        break;
                    }
                }

                if (targetIndex === -1) return;
                const cafe = cafeData[targetPref][targetIndex];

                const newName = prompt("æ–°ã—ã„åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", cafe.name);
                if (newName === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

                const newInsta = prompt("æ–°ã—ã„Instagramã®æŠ•ç¨¿URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", cafe.insta);
                if (newInsta === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

                // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                cafe.name = newName || cafe.name;
                cafe.insta = newInsta || cafe.insta;

                saveAndRefresh();
            };

            window.deleteCafe = function (cafeId) {
                if (!confirm("ã“ã®ã‚«ãƒ•ã‚§ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã€Œè¡Œã£ãŸã€è¨˜éŒ²ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) return;

                // ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                for (let prefId in cafeData) {
                    cafeData[prefId] = cafeData[prefId].filter((c) => c.id !== cafeId);
                }
                // è¨ªå•ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤
                visitedList = visitedList.filter((id) => id !== cafeId);
                // ãƒ¡ãƒ¢ã‹ã‚‰ã‚‚å‰Šé™¤
                delete memoData[cafeId];

                saveAndRefresh();
            };

            function saveAndRefresh() {
                localStorage.setItem("myCafeData", JSON.stringify(cafeData));
                localStorage.setItem("visitedCafes", JSON.stringify(visitedList));
                localStorage.setItem("cafeMemos", JSON.stringify(memoData));

                if (currentMode === "history") renderHistory();
                else renderCafes();
                renderMap();
            }

            // ----------------------------

            window.toggleVisit = function (cafeId) {
                const index = visitedList.indexOf(cafeId);
                if (index > -1) {
                    visitedList.splice(index, 1);
                } else {
                    visitedList.push(cafeId);
                    const now = new Date();
                    const dateStr = `ã€${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} è¨ªå•ã€‘\n`;
                    const memoEl = document.getElementById(`memo-${cafeId}`);
                    if (memoEl) {
                        memoEl.value = dateStr + memoEl.value;
                        saveMemo(cafeId, memoEl.value);
                    }
                }
                saveAndRefresh();
            };

            window.saveMemo = function (cafeId, text) {
                memoData[cafeId] = text;
                localStorage.setItem("cafeMemos", JSON.stringify(memoData));
            };

            window.addNewCafe = function () {
                const name = document.getElementById("new-cafe-name").value;
                const insta = document.getElementById("new-cafe-insta").value;
                if (!currentPrefId) {
                    alert("å…ˆã«åœ°å›³ã‹ã‚‰çœŒã‚’é¸ã‚“ã§ã­ï¼");
                    return;
                }
                if (!name || !insta) {
                    alert("åå‰ã¨URLã‚’å…¥åŠ›ã—ã¦ã­ï¼");
                    return;
                }

                const newCafe = { id: "c-" + Date.now(), name, insta };
                if (!cafeData[currentPrefId]) cafeData[currentPrefId] = [];
                cafeData[currentPrefId].push(newCafe);

                document.getElementById("new-cafe-name").value = "";
                document.getElementById("new-cafe-insta").value = "";
                saveAndRefresh();
            };

            renderMap();
        </script>
    </body>
</html>
