<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="UTF-8" />
        <title>Magical ToDo - Dreamy Galaxy</title>
        <style>
            /* --- ãƒ‡ã‚¶ã‚¤ãƒ³ã®è¨­å®šï¼ˆCSSï¼‰ --- */
            :root {
                --primary: #a855f7;
                --card: rgba(255, 255, 255, 0.85);
                --text: #4c1d95;
                --secondary: #e9d5ff;
                --accent: #f472b6;
                --sky-blue: #bae6fd;
            }

            /* ç”»é¢å…¨ä½“ã®èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            body {
                margin: 0;
                /* height: 100vh; ã‹ã‚‰ min-height ã«å¤‰æ›´ã—ã¦ã€ä¼¸ã³ç¸®ã¿ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
                min-height: 100vh;
                display: flex;
                justify-content: center;
                /* align-items: center; ã‚’å¤–ã™ã‹ã€padding ã‚’å…¥ã‚Œã¦ä¸Šã‹ã‚‰é…ç½®ã™ã‚‹ */
                align-items: flex-start;
                padding: 20px 0;
                font-family: "Arial Rounded MT Bold", sans-serif;
                background: linear-gradient(135deg, #fbcfe8 0%, #e9d5ff 50%, #bae6fd 100%);
                background-size: 400% 400%;
                animation: flowBG 15s ease infinite;
                /* âŒ overflow: hidden; ã‚’å‰Šé™¤ã€‚ã“ã‚Œã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ */
                color: var(--text);
            }

            @keyframes flowBG {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }

            /* æ˜Ÿå±‘ã®ç¬ãè¨­å®š */
            .star {
                position: fixed;
                background: white;
                border-radius: 50%;
                pointer-events: none;
                opacity: 0;
                z-index: 0;
                animation: blink var(--duration) infinite ease-in-out;
            }

            @keyframes blink {
                0%,
                100% {
                    opacity: 0;
                    transform: scale(0.5);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.2);
                    box-shadow: 0 0 8px white;
                }
            }

            /* ãƒ¡ã‚¤ãƒ³ã®ã‚«ãƒ¼ãƒ‰éƒ¨åˆ† */
            .container {
                width: 90%;
                max-width: 400px;
                background: var(--card);
                padding: 20px;
                border-radius: 30px;
                border: 5px solid white;
                position: relative;
                backdrop-filter: blur(10px);
                z-index: 10;
                margin: 70px auto 20px auto;
            }

            /* ãƒšãƒƒãƒˆã®ã‚¦ã‚µã‚® ğŸ° */
            #pet {
                position: absolute;
                right: 20px;
                top: -60px;
                font-size: 55px;
                filter: drop-shadow(0 8px 10px rgba(244, 114, 182, 0.4));
                animation: float 4s infinite ease-in-out;
                z-index: 100;
            }

            @keyframes float {
                0%,
                100% {
                    transform: translateY(0) rotate(-5deg);
                }
                50% {
                    transform: translateY(-15px) rotate(5deg);
                }
            }

            /* æ€’ã‚Šãƒãƒ¼ã‚¯ã®å‹•ã */
            @keyframes angerPulse {
                0%,
                100% {
                    transform: scale(1) rotate(0deg);
                }
                50% {
                    transform: scale(1.3) rotate(15deg);
                }
            }

            #anger-mark {
                animation: angerPulse 0.5s infinite;
                filter: drop-shadow(0 0 5px red);
            }

            /* å†·ã‚„æ±—ã®å‹•ã */
            @keyframes sweatMove {
                0%,
                100% {
                    transform: translateY(0);
                    opacity: 0;
                }
                50% {
                    transform: translateY(5px);
                    opacity: 1;
                }
            }

            #sweat-mark {
                animation: sweatMove 1s infinite;
                position: absolute;
                top: 5px;
                right: -10px;
            }

            /* æ¿€ã—ãæ€’ã‚‹ï¼ˆéœ‡ãˆã‚‹ï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            @keyframes angryShake {
                0% {
                    transform: translateX(0) rotate(5deg);
                }
                25% {
                    transform: translateX(-3px) rotate(-5deg);
                }
                50% {
                    transform: translateX(3px) rotate(5deg);
                }
                75% {
                    transform: translateX(-3px) rotate(-5deg);
                }
                100% {
                    transform: translateX(0) rotate(5deg);
                }
            }

            .pet-angry {
                animation: angryShake 0.1s infinite !important;
                filter: drop-shadow(0 0 10px #ff0000) !important;
            }

            /* å–œã¶ï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            @keyframes happyJump {
                0%,
                100% {
                    transform: translateY(-15px) scale(1);
                }
                50% {
                    transform: translateY(-35px) scale(1.2);
                }
            }

            /* ã‚¸ãƒ£ãƒ³ãƒ—ä¸­ï¼ˆ.pet-happyãŒã¤ã„ã¦ã„ã‚‹é–“ï¼‰ã ã‘ã€å…ƒã®floatã‚’ä¸Šæ›¸ãã—ã¦æ­¢ã‚ã‚‹ */
            .pet-happy {
                animation: happyJump 0.3s ease-in-out 3 !important;
            }

            /* æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã®å¼·èª¿ï¼ˆãƒ”ãƒ³ã‚¯ã«å…‰ã‚‹ï¼‰ */
            @keyframes urgentGlow {
                0%,
                100% {
                    box-shadow: 0 0 5px #f472b6;
                    border-color: #f472b6;
                }
                50% {
                    box-shadow: 0 0 20px #f472b6;
                    border-color: #ffb6c1;
                    background-color: #fff1f2;
                }
            }

            .is-urgent {
                animation: urgentGlow 1.5s infinite;
            }

            /* å®Œäº†æ™‚ã«é£›ã³æ•£ã‚‹ã‚­ãƒ©ã‚­ãƒ© */
            .particle {
                position: fixed;
                pointer-events: none;
                z-index: 1000;
                font-size: 20px;
                animation: particleAnim 1s ease-out forwards;
            }

            /* --- âœ¨ æ”¹è‰¯ç‰ˆï¼šã±ãƒ¼ã‚“ï¼ã¨æ•£ã‚‰ã°ã‚‹ã‚­ãƒ©ã‚­ãƒ©æ¼”å‡º --- */
            .particle {
                position: fixed;
                pointer-events: none;
                z-index: 1000;
                font-size: 45px;
                /* å¸¸ã«ä¸­å¤®ã‹ã‚‰é–‹å§‹ã—ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§ç§»å‹•ã•ã›ã‚‹ */
                transform: translate(-50%, -50%);
                animation: particleAnim 1.2s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;
            }

            @keyframes particleAnim {
                0% {
                    transform: translate(-50%, -50%) scale(0);
                    opacity: 0;
                }
                15% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1.2);
                }
                100% {
                    /* ã“ã“ã§è¨­å®šã—ãŸæ–¹å‘ã«é£›ã°ã—ã¦ã„ã¾ã™ï¼ */
                    transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(var(--rot)) scale(0);
                    opacity: 0;
                }
            }

            h1 {
                text-align: center;
                color: var(--primary);
                margin-bottom: 25px;
                font-size: 1.8rem;
            }

            /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
            .status-board {
                display: flex;
                justify-content: space-around;
                background: rgba(255, 255, 255, 0.4);
                padding: 12px;
                border-radius: 20px;
                font-size: 0.75rem;
                margin-bottom: 20px;
                border: 2px dashed var(--primary);
                font-weight: bold;
            }

            /* --- ğŸ€ å…¥åŠ›ã‚¨ãƒªã‚¢ --- */
            .input-group {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
            }

            input,
            select {
                padding: 14px;
                border: 2px solid var(--secondary);
                border-radius: 15px;
                outline: none;
                font-size: 1rem;
            }

            input:focus {
                border-color: var(--accent);
                transform: translateY(-2px);
                box-shadow: 0 0 15px var(--glow);
            }

            .row {
                display: flex;
                gap: 8px;
            }

            button {
                padding: 14px;
                border-radius: 15px;
                border: none;
                background: linear-gradient(135deg, var(--primary), var(--accent));
                color: white;
                font-weight: bold;
                cursor: pointer;
                transition: 0.3s;
            }

            button:hover {
                transform: translateY(-2px);
                filter: brightness(1.1);
            }

            /* --- ğŸ“ ãƒªã‚¹ãƒˆè¡¨ç¤º --- */
            #list {
                padding-right: 5px;
            }

            .todo-item {
                display: flex;
                flex-direction: column; /* ç¸¦ã«ä¸¦ã¹ã‚‹ */
                gap: 0;
                padding: 15px;
                background: white;
                border-radius: 18px;
                margin-top: 10px;
                border: 1px solid var(--secondary);
            }

            .todo-info {
                flex: 1;
            }

            .todo-meta {
                font-size: 0.7rem;
                color: var(--primary);
                opacity: 0.7;
                margin-top: 4px;
            }

            /* ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯éƒ¨åˆ†ã ã‘ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ */
            .todo-main {
                display: flex;
                align-items: center;
                width: 100%;
                gap: 10px;
            }

            /* ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
            .subtask-list {
                margin-top: 10px;
                margin-left: 30px; /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ†ã ã‘å³ã«å¯„ã›ã‚‹ */
                padding-left: 10px;
                border-left: 2px dotted var(--secondary);
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .subtask-item {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.85rem;
            }
        </style>
    </head>
    <body id="starry-body">
        <div class="container">
            <div id="pet">
                <span id="pet-emoji">ğŸ°</span>
                <span id="anger-mark" style="display: none; position: absolute; top: -10px; right: -10px; font-size: 25px">ğŸ’¢</span>
                <span id="sweat-mark" style="display: none; position: absolute; top: 5px; right: -10px; font-size: 20px">ğŸ’¦</span>
            </div>

            <h1>Magical Task Master</h1>

            <div class="status-board">
                <div>ğŸª„ MANA: <span id="energy">100</span>%</div>
                <div>ğŸ‘‘ RANK: <span id="rank">NOVICE</span></div>
                <div>ğŸŒˆ MAGIC: <span id="uptime">0</span>s</div>
            </div>

            <div class="input-group">
                <input type="text" id="todoIn" placeholder="é­”æ³•ã§è§£æ±ºã™ã‚‹ã‚¿ã‚¹ã‚¯..." />
                <div class="row">
                    <input type="date" id="dateIn" style="flex: 1.5" />
                    <select id="repeatIn" style="flex: 1">
                        <option value="none">1å›</option>
                        <option value="daily">æ¯æ—¥</option>
                        <option value="weekly">æ¯é€±</option>
                        <option value="monthly">æ¯æœˆ</option>
                    </select>
                </div>
                <button onclick="add()">CAST SPELL âœ¨</button>
            </div>

            <div id="list"></div>

            <!-- åˆè¨€è‘‰ã‚’å…¥åŠ›ãƒ»å‡ºåŠ›ã™ã‚‹ãŸã‚ã®ã‚¨ãƒªã‚¢ -->
            <div
                class="magic-sync"
                style="
                    margin-top: 30px;
                    padding: 15px;
                    border: 1px solid rgba(168, 85, 247, 0.3);
                    border-radius: 20px;
                    background: rgba(255, 255, 255, 0.2);
                "
            >
                <p
                    style="
                        font-size: 0.8rem;
                        margin: 0 0 10px 0;
                        color: var(--primary);
                        font-weight: bold;
                        text-align: center;
                        opacity: 0.6;
                    "
                >
                    âœ¨ ãƒ‡ãƒ¼ã‚¿ã®å¼•ç¶™ãï¼ˆé­”æ³•ã®åˆè¨€è‘‰ï¼‰
                </p>
                <textarea
                    id="sync-text"
                    placeholder="ã“ã“ã«åˆè¨€è‘‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€æ›¸ãå‡ºã—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­"
                    style="
                        width: 100%;
                        height: 60px;
                        font-size: 0.7rem;
                        margin: 5px 0;
                        opacity: 0.5;
                        border: 1px solid rgba(0, 0, 0, 0.1);
                        border-radius: 10px;
                        outline: none;
                    "
                >
                </textarea>
                <div style="display: flex; gap: 8px; margin-top: 10px">
                    <button
                        onclick="exportData()"
                        style="flex: 1; padding: 10px; font-size: 0.7rem; background: var(--secondary); color: var(--text)"
                    >
                        ğŸ“œ åˆè¨€è‘‰ã‚’ä½œã‚‹
                    </button>
                    <button onclick="importData()" style="flex: 1; padding: 10px; font-size: 0.7rem">ğŸ”® åˆè¨€è‘‰ã‚’å”±ãˆã‚‹</button>
                </div>
            </div>
        </div>

        <script>
            /* --- é­”æ³•ã®ä»•çµ„ã¿ï¼ˆJavaScriptï¼‰ --- */

            // ğŸŒŸ èƒŒæ™¯ã«ã‚­ãƒ©ã‚­ãƒ©ã®æ˜Ÿã‚’60å€‹ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã™ã‚‹é–¢æ•°
            function createStars() {
                const body = document.getElementById("starry-body");
                for (let i = 0; i < 60; i++) {
                    const star = document.createElement("div");
                    star.className = "star";
                    const size = Math.random() * 4 + 1 + "px";
                    star.style.width = size;
                    star.style.height = size;
                    star.style.left = Math.random() * 100 + "vw";
                    star.style.top = Math.random() * 100 + "vh";
                    star.style.setProperty("--duration", Math.random() * 3 + 2 + "s");
                    body.appendChild(star);
                }
            }
            createStars();

            // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ä¿å­˜é ˜åŸŸã‹ã‚‰å–å¾—ï¼‰
            let todos = JSON.parse(localStorage.getItem("dreamy-todos-v2")) || [];
            let upSeconds = 0;
            let totalDone = parseInt(localStorage.getItem("magical-done-count")) || 0;

            // 1ç§’ã”ã¨ã«é­”æ³•ã®æ™‚é–“ï¼ˆuptimeï¼‰ã‚’å¢—ã‚„ã™ã‚¿ã‚¤ãƒãƒ¼
            setInterval(() => {
                upSeconds++;
                document.getElementById("uptime").textContent = upSeconds;
            }, 1000);

            // âœ¨ æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
            function add() {
                const text = document.getElementById("todoIn").value;
                const date = document.getElementById("dateIn").value;
                const repeat = document.getElementById("repeatIn").value;
                if (!text) return; // ç©ºã£ã½ãªã‚‰è¿½åŠ ã—ãªã„

                // ã‚¿ã‚¹ã‚¯ã‚’é…åˆ—ã«è¿½åŠ 
                todos.push({ id: Date.now(), text, date, repeat, done: false });
                saveAndRender(); // ä¿å­˜ã—ã¦ç”»é¢ã‚’æ›´æ–°
                document.getElementById("todoIn").value = ""; // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
            }

            // ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¿½åŠ 
            function addSub(parentId) {
                const subText = prompt("ã‚µãƒ–ã‚¿ã‚¹ã‚¯ï¼ˆå°ã•ãªé­”æ³•ï¼‰ã‚’å…¥åŠ›ï¼š");
                if (!subText) return;
                todos = todos.map((t) => {
                    if (t.id === parentId) {
                        return { ...t, subtasks: [...(t.subtasks || []), { id: Date.now(), text: subText, done: false }] };
                    }
                    return t;
                });
                saveAndRender();
            }

            // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ç·¨é›†
            function editSub(parentId, subId) {
                todos = todos.map((t) => {
                    if (t.id === parentId) {
                        const newSubs = t.subtasks.map((s) => {
                            if (s.id === subId) {
                                const newText = prompt("ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’ä¿®æ­£ï¼š", s.text);
                                return newText ? { ...s, text: newText } : s;
                            }
                            return s;
                        });
                        return { ...t, subtasks: newSubs };
                    }
                    return t;
                });
                saveAndRender();
            }

            // ã‚µãƒ–ã‚¿ã‚¹ã‚¯å‰Šé™¤
            function removeSub(parentId, subId) {
                todos = todos.map((t) => {
                    if (t.id === parentId) {
                        return { ...t, subtasks: t.subtasks.filter((s) => s.id !== subId) };
                    }
                    return t;
                });
                saveAndRender();
            }

            // ã‚µãƒ–ã‚¿ã‚¹ã‚¯å®Œäº†åˆ‡ã‚Šæ›¿ãˆ
            function toggleSub(parentId, subId, event) {
                if (event && event.target.checked) {
                    const rect = event.target.getBoundingClientRect();
                    burst(rect.left + rect.width / 2, rect.top + rect.height / 2);
                }
                todos = todos.map((t) => {
                    if (t.id === parentId) {
                        const newSubs = t.subtasks.map((s) => (s.id === subId ? { ...s, done: !s.done } : s));
                        // ã‚µãƒ–ã‚¿ã‚¹ã‚¯å…¨å®Œäº†ãªã‚‰è¦ªã‚‚å®Œäº†ã•ã›ã‚‹
                        const allDone = newSubs.length > 0 && newSubs.every((s) => s.done);
                        if (allDone && !t.done) {
                            setTimeout(() => {
                                const el = document.querySelector(`input[data-parent="${parentId}"]`);
                                if (el) el.click();
                            }, 200);
                        }
                        return { ...t, subtasks: newSubs };
                    }
                    return t;
                });
                saveAndRender();
            }

            // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯å®Œäº†åˆ‡ã‚Šæ›¿ãˆ
            function toggle(id, event) {
                // ãƒã‚§ãƒƒã‚¯ã‚’ã¤ã‘ãŸç¬é–“ã®æ¼”å‡º
                if (event && event.target.checked) {
                    burst(event.clientX, event.clientY);

                    const petEl = document.getElementById("pet");

                    // ä¸€æ—¦ã‚¯ãƒ©ã‚¹ã‚’æ¶ˆã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œã‚¢ãƒ‹ãƒ¡ãŒçµ‚ã‚ã£ãŸã€ã¨æ€ã‚ã›ã‚‹
                    petEl.classList.remove("pet-happy");

                    // ãŠã¾ã˜ãªã„ï¼šã“ã‚ŒãŒãªã„ã¨Chromeã¯ã€Œã•ã£ãã¨åŒã˜çŠ¶æ…‹ã€ã¨åˆ¤æ–­ã—ã¦å‹•ã‹ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™
                    void petEl.offsetWidth;

                    // å†åº¦ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹
                    petEl.classList.add("pet-happy");

                    // ã‚¢ãƒ‹ãƒ¡ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã£ã¦ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’æ¶ˆã™ï¼ˆå°‘ã—é•·ã‚ã®1ç§’ã«è¨­å®šï¼‰
                    setTimeout(() => petEl.classList.remove("pet-happy"), 1000);
                }

                todos = todos.map((t) => {
                    if (t.id === id) {
                        const isChecking = !t.done;
                        if (isChecking) {
                            totalDone++; // ç´¯è¨ˆã‚¯ãƒªã‚¢æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—

                            // ã€é‡è¦ã€‘ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ã®å ´åˆã€æ—¥ä»˜ã‚’æ›´æ–°ã™ã‚‹
                            if (t.repeat !== "none") {
                                const oldDate = t.date;
                                let baseDate = t.date ? new Date(t.date) : new Date();
                                if (isNaN(baseDate.getTime())) baseDate = new Date();

                                // ç¹°ã‚Šè¿”ã—ã®ç¨®é¡ã«åˆã‚ã›ã¦æ—¥ä»˜è¨ˆç®—
                                if (t.repeat === "daily") baseDate.setDate(baseDate.getDate() + 1);
                                else if (t.repeat === "weekly") baseDate.setDate(baseDate.getDate() + 7);
                                else if (t.repeat === "monthly") baseDate.setMonth(baseDate.getMonth() + 1);

                                const nextDateStr = baseDate.toISOString().split("T")[0];

                                // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
                                if (t.repeat === "daily") {
                                    alert("é­”æ³•ã®æ›´æ–°ï¼æ˜æ—¥ã®è‡ªåˆ†ã¸è¨—ã—ã¾ã—ãŸğŸŒˆ");
                                } else {
                                    alert(`é­”æ³•ã®æ›´æ–°ï¼æ¬¡ã¯ã€ ${nextDateStr} ã€‘ã§ã™ğŸŒˆ`);
                                }

                                // æ–°ã—ã„æ—¥ä»˜ã«æ›¸ãæ›ãˆã¦ã€Œå®Œäº†ã€çŠ¶æ…‹ã«ã™ã‚‹
                                return { ...t, done: true, date: nextDateStr, oldDate: oldDate };
                            }
                        } else {
                            // ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸæ™‚ã®å‡¦ç†
                            totalDone = Math.max(0, totalDone - 1);
                            if (t.oldDate) return { ...t, done: false, date: t.oldDate, oldDate: null };
                        }
                        return { ...t, done: isChecking };
                    }
                    return t;
                });
                saveAndRender();

                // 2ç§’å¾Œã«ã€Œå®Œäº†ã€ã®ãƒã‚§ãƒƒã‚¯ã‚’è‡ªå‹•çš„ã«å¤–ã™ï¼ˆæ¬¡ã®æ—¥ã®æº–å‚™ï¼‰
                setTimeout(() => {
                    let changed = false;
                    todos = todos.map((t) => {
                        if (t.id === id && t.oldDate && t.done) {
                            changed = true;
                            return { ...t, done: false }; // æœªå®Œäº†ã«æˆ»ã—ã¦ãƒªã‚¹ãƒˆã«æ®‹ã™
                        }
                        return t;
                    });
                    if (changed) saveAndRender();
                }, 2000);
            }

            // ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
            function remove(id) {
                todos = todos.filter((t) => t.id !== id);
                saveAndRender();
            }

            // ğŸ’¾ ä¿å­˜ã¨ä¸¦ã³æ›¿ãˆã‚’ã—ã¦ã‹ã‚‰æç”»ã™ã‚‹é–¢æ•°
            function saveAndRender() {
                // æ—¥ä»˜ãŒè¿‘ã„é †ã«ä¸¦ã³æ›¿ãˆã‚‹
                todos.sort((a, b) => {
                    const hasA = a.date && a.date !== "";
                    const hasB = b.date && b.date !== "";
                    if (hasA && !hasB) return -1;
                    if (!hasA && hasB) return 1;
                    if (hasA && hasB) return new Date(a.date) - new Date(b.date);
                    return 0;
                });
                // ä¿å­˜
                localStorage.setItem("dreamy-todos-v2", JSON.stringify(todos));
                localStorage.setItem("magical-done-count", totalDone);
                render(); // ç”»é¢ã«è¡¨ç¤º
            }

            // ğŸ–¼ï¸ ç”»é¢ã‚’æ›¸ãæ›ãˆã‚‹é–¢æ•°ï¼ˆä¸€ç•ªã‚ˆãå‹•ãéƒ¨åˆ†ï¼‰
            function render() {
                const list = document.getElementById("list");
                list.innerHTML = ""; // ä¸€æ—¦ãƒªã‚¹ãƒˆã‚’ç©ºã«ã™ã‚‹

                const now = new Date();
                const today =
                    now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0") + "-" + String(now.getDate()).padStart(2, "0");

                let hasOverdue = false; // æœŸé™åˆ‡ã‚ŒãŒã‚ã‚‹ã‹ã©ã†ã‹ã®ç›®å°

                todos.forEach((t) => {
                    // æœŸé™ã‚’éãã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const isOverdue = !t.done && t.date && t.date < today;
                    if (isOverdue) hasOverdue = true;

                    // ã‚¿ã‚¹ã‚¯1ã¤åˆ†ã®HTMLã‚’ä½œæˆ
                    const div = document.createElement("div");
                    div.className = `todo-item ${isOverdue ? "is-urgent" : ""}`;
                    div.innerHTML = `
                    <div class="todo-main">
                    <input type="checkbox" ${t.done ? "checked" : ""} onchange="toggle(${t.id}, event)" data-parent="${t.id}">
                    <div class="todo-info">
                    <div style="${t.done ? "text-decoration:line-through; opacity:0.5" : ""}">${t.text}</div>
                    <div class="todo-meta">
                        ${isOverdue ? '<span style="color:#f472b6; font-weight:bold;">âš ï¸ æ—©ãã‚„ã£ã¦ï¼</span> ' : ""}
                        ${t.date ? "ğŸ“… " + t.date : ""} 
                        ${t.repeat !== "none" ? " ğŸ”„ " + (t.repeat === "monthly" ? "æ¯æœˆ" : t.repeat === "weekly" ? "æ¯é€±" : "æ¯æ—¥") : ""}
                    </div>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button style="background:none; color:var(--primary); font-size:1.2rem; padding:0 5px; width:auto;" onclick="addSub(${
                        t.id
                    })">ï¼‹</button>
                    <button style="background:none; color:var(--primary); font-size:1.1rem; padding:0 5px; width:auto;" onclick="editTask(${
                        t.id
                    })">âœ</button>
                    <button style="background:none; color:#ffb6c1; font-size:1.5rem; padding:0 5px; width:auto; line-height:1;" onclick="event.stopPropagation(); remove(${
                        t.id
                    })">Ã—</button>
                </div>
            </div>
    
            ${
                t.subtasks && t.subtasks.length > 0
                    ? `
                <div class="subtask-list">
                    ${t.subtasks
                        .map(
                            (s) => `
                        <div class="subtask-item" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" ${s.done ? "checked" : ""} onchange="toggleSub(${t.id}, ${s.id}, event)">
                            <span style="flex:1; font-size:0.9rem; ${
                                s.done ? "text-decoration:line-through; opacity:0.5" : ""
                            }" onclick="editSub(${t.id}, ${s.id})">
                                ${s.text}
                            </span>
                            <button style="background:none; color:#ffb6c1; border:none; cursor:pointer; font-size:1rem;" onclick="removeSub(${
                                t.id
                            }, ${s.id})">Ã—</button>
                        </div>
                    `
                        )
                        .join("")}
                </div>
            `
                    : ""
            }
        `;
                    list.appendChild(div);
                });

                // ãƒãƒŠã®è¨ˆç®—ï¼ˆã‚¿ã‚¹ã‚¯ãŒæºœã¾ã‚‹ã»ã©æ¸›ã‚‹ï¼‰
                const mana = calculateMana();
                document.getElementById("energy").textContent = mana;

                // ğŸ° ã‚¦ã‚µã‚®ã®çŠ¶æ…‹ï¼ˆæ„Ÿæƒ…ï¼‰ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
                const pet = document.getElementById("pet");
                const angerMark = document.getElementById("anger-mark");
                const sweatMark = document.getElementById("sweat-mark");

                if (hasOverdue) {
                    // æœŸé™åˆ‡ã‚ŒãŒã‚ã‚Œã°æ¿€æ€’
                    pet.classList.add("pet-angry");
                    angerMark.style.display = "block";
                    sweatMark.style.display = "none";
                } else if (mana === 0) {
                    // ã‚¿ã‚¹ã‚¯ãŒå¤šã™ãã‚‹ã¨å†·ã‚„æ±—
                    pet.classList.remove("pet-angry");
                    angerMark.style.display = "none";
                    sweatMark.style.display = "block";
                } else {
                    // å¹³å’Œãªæ™‚ã¯é€šå¸¸
                    pet.classList.remove("pet-angry");
                    angerMark.style.display = "none";
                    sweatMark.style.display = "none";
                }

                // ã‚¯ãƒªã‚¢æ•°ã«å¿œã˜ã¦ãƒ©ãƒ³ã‚¯ï¼ˆç§°å·ï¼‰ã‚’æ›´æ–°
                const ranks = ["NOVICE", "WIZARD", "ARCHMAGE", "LEGEND"];
                document.getElementById("rank").textContent = ranks[Math.min(Math.floor(totalDone / 5), 3)];
            }

            // âœ ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ã™ã‚‹é–¢æ•°
            function editTask(id) {
                const task = todos.find((t) => t.id === id);
                if (!task) return;
                document.getElementById("todoIn").value = task.text;
                document.getElementById("dateIn").value = task.date;
                document.getElementById("repeatIn").value = task.repeat;
                remove(id); // ä¸€æ—¦æ¶ˆã—ã¦ã€ç·¨é›†å¾Œã«å†è¿½åŠ ã™ã‚‹ä»•çµ„ã¿
                document.getElementById("todoIn").focus();
            }

            // --- ğŸŒ¸ 2ç§’é–“ã‚†ã£ãŸã‚Šã‚­ãƒ©ã‚­ãƒ©æ¼”å‡º ---
            function burst(x, y) {
                const emojis = ["âœ¨", "â­", "ğŸŒŸ", "ğŸŒ¸", "ğŸŒˆ", "ğŸ­", "ğŸ’", "ğŸ¨"];
                for (let i = 0; i < 20; i++) {
                    const p = document.createElement("div");
                    p.className = "particle";
                    p.textContent = emojis[Math.floor(Math.random() * emojis.length)];

                    p.style.left = x - 20 + "px";
                    p.style.top = y - 20 + "px";
                    document.body.appendChild(p);

                    const angle = Math.random() * Math.PI * 2;
                    const dist = 120 + Math.random() * 300; // é£›ã¶è·é›¢
                    const dx = Math.cos(angle) * dist;
                    const dy = Math.sin(angle) * dist;
                    const rot = Math.random() * 800 - 400; // å›è»¢é‡

                    p.animate(
                        [
                            { transform: "translate(0, 0) scale(0) rotate(0deg)", opacity: 0 },
                            { transform: "translate(0, 0) scale(1.5) rotate(0deg)", opacity: 1, offset: 0.15 }, // æœ€åˆã¯ãƒ‘ãƒƒã¨å‡ºã‚‹
                            { transform: `translate(${dx}px, ${dy}px) scale(0.5) rotate(${rot}deg)`, opacity: 0.8, offset: 0.8 }, // ã‚†ã£ãã‚Šæ¼‚ã†
                            { transform: `translate(${dx * 1.2}px, ${dy * 1.2}px) scale(0) rotate(${rot * 1.2}deg)`, opacity: 0 }, // æœ€å¾Œã«æ¶ˆãˆã‚‹
                        ],
                        {
                            duration: 2000, // ã“ã“ã‚’ 2000ms (2ç§’) ã«ã—ã¦ã‚†ã£ãã‚Šã«ã—ã¾ã—ãŸ
                            easing: "cubic-bezier(0.1, 0.5, 0.3, 1)", // æ¸›é€Ÿæ„Ÿã‚’å¼·ã‚ãŸè¨­å®š
                            fill: "forwards",
                        }
                    ).onfinish = () => p.remove();
                }
            }

            // ğŸª„ ãƒãƒŠã®æ®‹ã‚Šãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
            function calculateMana() {
                const undoneCount = todos.filter((t) => !t.done).length;
                // 1ã‚¿ã‚¹ã‚¯ã«ã¤ã10%æ¸›ã‚‹è¨ˆç®—
                return Math.max(0, 100 - undoneCount * 10);
            }

            // 1. ä»Šã®ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œåˆè¨€è‘‰ã€ã«å¤‰ãˆã‚‹
            function exportData() {
                const todoData = localStorage.getItem("dreamy-todos-v2");
                const doneCount = localStorage.getItem("magical-done-count") || "0";

                if (!todoData || todoData === "[]") {
                    alert("æ›¸ãå‡ºã™ã‚¿ã‚¹ã‚¯ãŒãªã„ã‚ˆï¼");
                    return;
                }

                // ã‚¿ã‚¹ã‚¯ã¨ã‚¯ãƒªã‚¢æ•°ã‚’ã‚»ãƒƒãƒˆã«ã—ã¦åˆè¨€è‘‰ã«ã™ã‚‹
                const combinedData = JSON.stringify({
                    todos: JSON.parse(todoData),
                    count: doneCount,
                });

                const spell = btoa(unescape(encodeURIComponent(combinedData)));
                document.getElementById("sync-text").value = spell;

                document.getElementById("sync-text").select();
                document.execCommand("copy");
                alert("ã€Œé­”æ³•ã®åˆè¨€è‘‰ã€ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼ã“ã‚Œã‚’ã‚¹ãƒãƒ›ã«é€ã£ã¦ã­ã€‚");
            }

            // 2. ã€Œåˆè¨€è‘‰ã€ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™
            function importData() {
                const spell = document.getElementById("sync-text").value.trim();
                if (!spell) {
                    alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
                    return;
                }

                try {
                    const decodedData = decodeURIComponent(escape(atob(spell)));
                    const parsed = JSON.parse(decodedData);

                    if (confirm("ä»Šã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã‘ã©å¤§ä¸ˆå¤«ï¼Ÿ")) {
                        // ãƒ‡ãƒ¼ã‚¿ã‚’ãã‚Œãã‚Œã®ä¿å­˜å ´æ‰€ã«ã‚»ãƒƒãƒˆ
                        localStorage.setItem("dreamy-todos-v2", JSON.stringify(parsed.todos));
                        localStorage.setItem("magical-done-count", parsed.count);

                        alert("é­”æ³•ãŒæˆåŠŸã—ãŸã‚ˆï¼åŒæœŸã‚’å®Œäº†ã—ã¾ã™ğŸŒˆ");
                        location.reload();
                    }
                } catch (e) {
                    alert("åˆè¨€è‘‰ãŒé–“é•ã£ã¦ã„ã‚‹ã¿ãŸã„ã€‚ã‚³ãƒ”ãƒ¼ãŒæ­£ã—ãã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼");
                }
            }

            // èµ·å‹•æ™‚ã«ä¸€åº¦å®Ÿè¡Œã—ã¦ç”»é¢ã‚’ä½œã‚‹
            render();
        </script>
    </body>
</html>
